{% extends "base.html" %}

{% block title %}
Dashboard
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-12">
            <div class="row">

                {% if g.user %}
                <!-- User Info Left -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-lg border-0 h-100">
                        <div class="card-body">
                            <form id="avatar-form" action="{{ url_for('dashboard.upload_avatar') }}" method="post"
                                enctype="multipart/form-data" class="mt-2 mb-3 text-center">
                                <label for="avatar" style="cursor:pointer; display:block;">
                                    {% if g.user.avatar %}
                                    <img src="{{ url_for('static', filename=g.user.avatar) }}" alt="Avatar"
                                        class="rounded-circle shadow mb-3" width="96" height="96" id="avatar-img">
                                    {% else %}
                                    <img src="https://ui-avatars.com/api/?name={{ g.user.nickname|default('User') }}&size=96&background=0D8ABC&color=fff"
                                        alt="Default Avatar" class="rounded-circle shadow mb-3" width="96" height="96"
                                        id="avatar-img">
                                    {% endif %}
                                </label>
                                <input type="file" name="avatar" id="avatar" accept="image/*" style="display:none"
                                    required>
                            </form>
                            <h2 class="card-title mb-1 text-center" id="greeting-line"><strong>{{ g.user.nickname
                                    }}</strong></h2>
                            <div class="card mb-3 shadow-sm border-0">
                                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                    <strong>Personal Information</strong>
                                </div>
                                <div class="card-body p-3">
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Username:</strong></div>
                                        <div class="col-7">{{ g.user.username }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Email:</strong></div>
                                        <div class="col-7">{{ g.user.email }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Date of Birth:</strong></div>
                                        <div class="col-7">{{ g.user.date_of_birth or 'N/A' }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Sex:</strong></div>
                                        <div class="col-7">{{ g.user.sex or 'N/A' }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Height (cm):</strong></div>
                                        <div class="col-7">{{ g.user.height or 'N/A' }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Weight (kg):</strong></div>
                                        <div class="col-7">{{ g.user.weight or 'N/A' }}</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Weather Forecast Card START -->
                            <div class="card mb-4 shadow-sm border-0">
                                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                    <strong>Weather Forecast (Next 5 Days)</strong>
                                </div>
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between flex-nowrap overflow-auto gap-2">
                                        {% for day in weather_forecast %}
                                        <div
                                            class="weather-day-card flex-shrink-0 text-center p-2 border rounded bg-light">
                                            <div class="fw-bold" style="font-size: 1rem;">{{ day.date }}</div>
                                            <div>
                                                <img src="{{ day.icon_url }}" alt="weather" width="28" height="28">
                                            </div>
                                            <div style="font-size: 1rem;">{{ day.temp }}Â°C</div>
                                            <div class="text-muted" style="font-size:0.85em;">{{ day.description }}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <!-- Weather Forecast Card END -->

                            <!-- Calendar Card START -->
                            <div class="card mb-4 shadow-sm border-0">
                                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                    <strong>Calendar</strong>
                                </div>
                                <div class="card-body p-3">
                                    <div id="calendar"></div>
                                </div>
                            </div>
                            <!-- Calendar Card END -->
                            <div class="mt-3">
                                <a href="{{ url_for('user.password') }}" class="btn btn-link p-0 me-3">Reset
                                    Password</a>
                                <a href="{{ url_for('user.logout') }}" class="btn btn-link text-danger p-0">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Charts Right -->
                <!-- Achievements Card START -->
                <div class="col-lg-8">
                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0 mb-4">
                                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                    <strong>Achievements</strong>
                                </div>
                                <div class="card-body p-3">
                                    {% if achievements %}
                                    <div class="d-flex flex-wrap gap-3 justify-content-center">
                                        {% for ach in achievements %}
                                        <div class="achievement-card d-flex flex-column align-items-center p-3">
                                            <i class="bi bi-trophy-fill text-warning" style="font-size: 2rem;"></i>
                                            <span class="mt-2" style="font-weight: 500;">{{ ach }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-muted text-center">No achievements yet. Start logging your
                                        activities!
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Achievements Card END -->

                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0 mb-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Calories Burned</h5>
                                    <canvas id="exerciseChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0 mb-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Calorie Intake</h5>
                                    <canvas id="intakeChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Weight Trend</h5>
                                    <canvas id="weightChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <div class="alert alert-info text-center">
                    <p>You are not logged in.</p>
                    <p>
                        <a href="{{ url_for('user.register') }}" class="btn btn-primary btn-sm">Register</a>
                        <a href="{{ url_for('user.login') }}" class="btn btn-outline-primary btn-sm">Login</a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />

<style>
    body {
        background: #292a2c51 !important;
        /* light grey */
    }

    .card {
        border-radius: 1rem;
    }

    .chart-card {
        min-height: 400px;
        background: linear-gradient(135deg, #f8fafc 60%, #e0e7ef 100%);
    }

    .card-header.bg-light {
        background: #f8fafc !important;
        font-size: 1.1rem;
        border-bottom: 1px solid #e0e7ef;
    }

    .card-body .row {
        align-items: center;
    }

    .card-body .col-5 {
        font-weight: 500;
    }

    .card-body .col-7 {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .rounded-circle {
        border: 3px solid #0d6efd;
    }

    .btn-link {
        text-decoration: none;
    }

    .btn-link:hover {
        text-decoration: underline;
    }

    /* Make the calendar more compact and modern */
    #calendar {
        font-size: 0.95rem;
        padding: 0.5rem;
    }

    .fc-header-toolbar {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .fc-toolbar-chunk:first-child {
        order: -1;
    }

    .fc-button,
    .fc-button-primary {
        padding: 0.15rem 0.5rem !important;
        font-size: 0.85rem !important;
        min-width: 32px;
    }

    .fc-toolbar-title {
        font-size: 1.2rem !important;
        font-weight: 600;
    }



    .fc .fc-button-group {
        gap: 0.25rem;
    }

    .fc {
        border-radius: 0.75rem;
        background: #f8fafc;
    }

    .card-body #calendar {
        margin: 0.5rem 0.25rem 0.25rem 0.25rem;
    }

    .weather-day-card {
        min-width: 80px;
        max-width: 90px;
        background: #f8fafc;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        border-radius: 0.75rem;
        margin-bottom: 0;
        padding: 0.5rem 0.25rem;
        transition: box-shadow 0.2s;
    }

    .weather-day-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        background: #e9f5ff;
    }
</style>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.getElementById('avatar').addEventListener('change', function () {
        if (this.files.length > 0) {
            document.getElementById('avatar-form').submit();
        }
    });
    document.addEventListener('DOMContentLoaded', function () {
        const greetingLine = document.getElementById('greeting-line');
        if (greetingLine) {
            const hour = new Date().getHours();
            let greeting = "Hello";
            let emoji = "ðŸ‘‹";
            if (hour >= 5 && hour < 12) {
                greeting = "Good morning";
                emoji = "ðŸŒ…";
            } else if (hour >= 12 && hour < 18) {
                greeting = "Good afternoon";
                emoji = "â˜€ï¸";
            } else if (hour >= 18 && hour < 22) {
                greeting = "Good evening";
                emoji = "ðŸŒ‡";
            } else {
                greeting = "Good night";
                emoji = "ðŸŒ™";
            }
            greetingLine.innerHTML = `<span>${emoji} ${greeting}, <strong>{{ g.user.nickname }}</strong></span>`;
        }
    });
</script>
<script>
    function getLast14DaysLabels() {
        const labels = [];
        const today = new Date();
        for (let i = 13; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            labels.push(label);
        }
        return labels;
    }

    const labels = getLast14DaysLabels();

    const burned = [300, 500, 450, 600, 700, 400, 500, 550, 620, 700, 600, 580, 640, 670];
    const intake = [2000, 2100, 1800, 2200, 2500, 2300, 2000, 1950, 2100, 2400, 2350, 2250, 2150, 2050];
    const weight = [70.0, 69.9, 69.8, 69.7, 69.6, 69.5, 69.4, 69.3, 69.2, 69.1, 69.0, 68.9, 68.8, 68.7];

    new Chart(document.getElementById('exerciseChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Calories Burned',
                data: burned,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('intakeChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Calories Intake',
                data: intake,
                backgroundColor: 'rgba(255, 159, 64, 0.6)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('weightChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Weight (kg)',
                data: weight,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                fill: false,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: false, title: { display: true, text: 'kg' } } } }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 350,
                headerToolbar: {
                    start: 'today',
                    center: 'title',
                    end: 'prev,next'
                },
                buttonText: {
                    today: 'Today'
                },
                events: []
            });
            calendar.render();
            // Custom: Update the Today button to show the day of week
            function updateTodayButton() {
                var todayBtn = calendarEl.querySelector('.fc-today-button');
                if (todayBtn) {
                    var today = new Date();
                    var weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
                    todayBtn.textContent = `Today (${weekday})`;
                }
            }
            updateTodayButton();
            // Also update after navigation (in case user clicks prev/next)
            calendar.on('datesSet', updateTodayButton);

        }
    });
</script>
{% endblock %}