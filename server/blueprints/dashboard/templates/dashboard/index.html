{% extends "base.html" %}

{% block title %}
Dashboard
{% endblock %}

{% set perth = pytz.timezone('Australia/Perth') %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row">

                {% if current_user.is_authenticated %}
                <!-- User Info Left -->
                <div class="col-lg-3 mb-4">
                    <div class="card shadow-lg border-0 h-100">
                        <div class="card-body">
                            <form id="avatar-form" action="{{ url_for('user.upload_avatar') }}" method="post"
                                enctype="multipart/form-data" class="mt-2 mb-3 text-center">
                                <label for="avatar" style="cursor:pointer; display:block;">
                                    {% if current_user.avatar %}
                                    <img src="{{ url_for('static', filename=current_user.avatar) }}" alt="Avatar"
                                        class="rounded-circle shadow mb-3" width="96" height="96" id="avatar-img">
                                    {% else %}
                                    <img src="https://ui-avatars.com/api/?name={{ current_user.nickname|default('User') }}&size=96&background=0D8ABC&color=fff"
                                        alt="Default Avatar" class="rounded-circle shadow mb-3" width="96" height="96"
                                        id="avatar-img">
                                    {% endif %}
                                </label>
                                <input type="file" name="avatar" id="avatar" accept="image/*" style="display:none"
                                    required>
                            </form>
                            <h2 class="card-title mb-1 text-center" id="greeting-line"><strong>{{ current_user.nickname
                                    }}</strong></h2>
                            <div class="card mb-3 shadow-sm border-0">
                                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                    <strong>Personal Information</strong>
                                </div>
                                <div class="card-body p-3">
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Username:</strong></div>
                                        <div class="col-7">{{ current_user.username }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Email:</strong></div>
                                        <div class="col-7">{{ current_user.email }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Date of Birth:</strong></div>
                                        <div class="col-7">{{ current_user.date_of_birth or 'N/A' }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Sex:</strong></div>
                                        <div class="col-7">{{ current_user.sex or 'N/A' }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Created At:</strong></div>
                                        <div class="col-7">
                                            {{ current_user.created_at.astimezone(perth).strftime('%Y-%m-%d %H:%M') if
                                            current_user.created_at else 'N/A' }}
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-5 text-muted"><strong>Last Login:</strong></div>
                                        <div class="col-7">
                                            {{ current_user.last_login.astimezone(perth).strftime('%Y-%m-%d %H:%M') if
                                            current_user.last_login else 'N/A' }}
                                        </div>
                                    </div>
                                </div>
                                <!-- Weather Forecast Card START -->
                                <div class="card mb-4 shadow-sm border-0">
                                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                        <strong>Weather Forecast (Next 5 Days)</strong>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between flex-nowrap overflow-auto gap-2">
                                            {% for day in weather_forecast %}
                                            <div
                                                class="weather-day-card flex-shrink-0 text-center p-2 border rounded bg-light">
                                                <div class="fw-bold" style="font-size: 1rem;">{{ day.date }}</div>
                                                <div>
                                                    <img src="{{ day.icon_url }}" alt="weather" width="28" height="28">
                                                </div>
                                                <div style="font-size: 1rem;">{{ day.temp }}¬∞C</div>
                                                <div class="text-muted" style="font-size:0.85em;">{{ day.description }}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <!-- Weather Forecast Card END -->

                                <!-- Calendar Card START -->
                                <div class="card mb-4 shadow-sm border-0">
                                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                        <strong>Calendar</strong>
                                    </div>
                                    <div class="card-body p-3">
                                        <div id="calendar"></div>
                                    </div>
                                </div>
                                <!-- Calendar Card END -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Charts Right -->
                <!-- Achievements Card START -->
                <div class="col-lg-5 mb-4">
                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0 mb-4">
                                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                    <strong>Achievements</strong>
                                </div>
                                <div class="card-body p-3">
                                    {% if achievements %}
                                    <div id="achievements-list">
                                        {% set icons = {
                                        'running': 'üèÉ‚Äç‚ôÇÔ∏è',
                                        'cycling': 'üö¥‚Äç‚ôÄÔ∏è',
                                        'swimming': 'üèä‚Äç‚ôÇÔ∏è',
                                        'weight_lifting': 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
                                        'yoga': 'üßò‚Äç‚ôÇÔ∏è'
                                        } %}
                                        {% set icon_colors = {
                                        'running': '#ffb700',
                                        'cycling': '#00b894',
                                        'swimming': '#0984e3',
                                        'weight_lifting': '#636e72',
                                        'yoga': '#a29bfe'
                                        } %}
                                        {% set badge_classes = ['badge-bronze', 'badge-silver', 'badge-gold'] %}
                                        {% set badge_labels = ['Bronze', 'Silver', 'Gold'] %}
                                        {% for ex_type, milestones in ACHIEVEMENTS.items() %}
                                        <div class="mb-2 d-flex align-items-center">
                                            <span class="achievement-icon me-2"
                                                style="background: {{ icon_colors[ex_type.value] }};">
                                                {{ icons[ex_type.value] }}
                                            </span>
                                            <strong style="font-size:1.1em;">{{ ex_type }}</strong>:
                                            <span class="ms-2">
                                                {% for milestone in milestones %}
                                                {% set idx = loop.index0 %}
                                                {% set badge_class = badge_classes[idx] %}
                                                {% set badge_label = badge_labels[idx] %}
                                                {% if milestone in achievements[ex_type] %}
                                                <span class="badge {{ badge_class }} me-1" title="{{ badge_label }}">{{
                                                    badge_label }} {{ milestone }}</span>
                                                {% else %}
                                                <span class="badge badge-locked me-1" title="{{ badge_label }}">{{
                                                    badge_label }} {{ milestone }}</span>
                                                {% endif %}
                                                {% endfor %}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-muted text-center">No achievements yet. Start logging your
                                        activities!</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Achievements Card END -->


                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0 mb-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Calories Burned</h5>
                                    <canvas id="exerciseChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0 mb-4">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Calorie Intake</h5>
                                    <canvas id="intakeChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="card chart-card shadow-sm border-0">
                                <div class="card-body">
                                    <h5 class="card-title text-center">Weight Trend</h5>
                                    <canvas id="weightChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Schedule & Goals -->
                <div class="col-lg-4 mb-4">
                    <!-- Schedule Card -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <strong>My Schedule</strong>
                            <!-- Add Button (opens modal) -->
                            <button class="btn btn-circle btn-add" data-bs-toggle="modal"
                                data-bs-target="#addScheduleModal">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-2 text-muted">
                                {{ now.strftime('%A, %d %b %y') }}
                            </div>
                            {% if scheduled_exercises %}
                            <ul class="list-unstyled">
                                {% for ex in scheduled_exercises %}
                                <li class="schedule-item d-flex align-items-start mb-3">
                                    <!-- Check/complete button (optional, add logic as needed) -->
                                    <button class="btn btn-check me-3" title="Mark as done">
                                        <i class="bi bi-circle"></i>
                                    </button>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold" style="font-size:1.1rem;">
                                            {{ ex.exercise_type }}


                                        </div>
                                        <div class="text-muted small">
                                            {{ ex.scheduled_time.strftime('%I:%M %p').lstrip('0') }}
                                            {% if ex.note %} &mdash; {{ ex.note }}{% endif %}
                                        </div>
                                    </div>
                                    <!-- Edit button (opens modal, implement logic as needed) -->
                                    <!-- Edit button -->
                                    <button class="btn btn-edit ms-2" title="Edit" data-bs-toggle="modal"
                                        data-bs-target="#editScheduleModal-{{ ex.id }}">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <!-- Edit Modal for each schedule item -->
                                    <div class="modal fade" id="editScheduleModal-{{ ex.id }}" tabindex="-1"
                                        aria-labelledby="editScheduleModalLabel-{{ ex.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form method="POST"
                                                    action="{{ url_for('dashboard.edit_schedule', id=ex.id) }}">
                                                    {{ form.hidden_tag() }}
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="editScheduleModalLabel-{{ ex.id }}">
                                                            Edit or Delete Exercise</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-2">
                                                            <label>Day</label>
                                                            <select name="day_of_week" class="form-select">
                                                                {% for val, label in form.day_of_week.choices %}
                                                                <option value="{{ val }}" {% if ex.day_of_week==val
                                                                    %}selected{% endif %}>{{ label }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label>Exercise</label>
                                                            <select name="exercise_type" class="form-select">
                                                                {% for val, label in form.exercise_type.choices %}
                                                                <option value="{{ val }}" {% if
                                                                    ex.exercise_type.value==val or ex.exercise_type==val
                                                                    %}selected{% endif %}>{{ label }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label>Time</label>
                                                            <input type="time" name="scheduled_time"
                                                                class="form-control"
                                                                value="{{ ex.scheduled_time.strftime('%H:%M') }}">
                                                        </div>
                                                        <div class="mb-2">
                                                            <label>Note</label>
                                                            <input type="text" name="note" class="form-control"
                                                                value="{{ ex.note }}">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer d-flex justify-content-between">
                                                        <button type="submit" class="btn btn-primary">Save
                                                            Changes</button>
                                                </form>
                                                <form method="POST"
                                                    action="{{ url_for('dashboard.delete_schedule', id=ex.id) }}"
                                                    onsubmit="return confirm('Delete this schedule?');">
                                                    <button type="submit" class="btn btn-danger">Delete</button>
                                                </form>
                                            </div>

                                        </div>
                                    </div>
                        </div>

                        {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-muted">No scheduled exercises.</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Add Schedule Modal -->
                <div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('dashboard.index') }}">
                                {{ form.hidden_tag() }}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addScheduleModalLabel">Add Exercise</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-2">{{ form.day_of_week.label }} {{
                                        form.day_of_week(class="form-select") }}</div>
                                    <div class="mb-2">{{ form.exercise_type.label }} {{
                                        form.exercise_type(class="form-select") }}</div>
                                    <div class="mb-2">{{ form.scheduled_time.label }} {{
                                        form.scheduled_time(class="form-control") }}</div>
                                    <div class="mb-2">{{ form.note.label }} {{ form.note(class="form-control") }}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">{{ form.submit(class="btn
                                        btn-primary") }}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Goals Card -->
                <!-- Goals List Card -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <strong>My Goals</strong>
                        <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        {% if goals %}
                        <ul class="list-group">
                            {% for goal in goals %}
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center position-relative goal-item">
                                <span>
                                    <strong>{{ goal.description }}</strong>
                                    <br>
                                    <span class="text-muted">
                                        {{ goal.exercise_type }}
                                    </span>
                                    <br>
                                    Target: {{ goal.target_value }} {{ goal.unit }}
                                </span>
                                <span class="d-flex flex-column align-items-end">
                                    <span class="badge bg-primary rounded-pill mb-2">
                                        {{ goal.current_value }} / {{ goal.target_value }}
                                    </span>
                                    <form method="POST" action="{{ url_for('dashboard.delete_goal', id=goal.id) }}"
                                        onsubmit="return confirm('Are you sure you want to give up this goal?');"
                                        class="delete-goal-form">
                                        <button type="submit"
                                            class="badge rounded-pill bg-white text-danger border border-danger give-up-badge-btn"
                                            style="font-size: 0.8rem;" title="Give Up Goal">
                                            Give Up
                                        </button>
                                    </form>
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-muted">No goals set yet.</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Exercise Log Card -->
                <div class="card chart-card shadow-sm border-0 mb-4">
                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                        <strong>Exercise Log</strong>
                    </div>
                    <div class="card-body p-3">
                        {% if exercises %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ex in exercises[:10] %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ ex.type }}</td>
                                    <td>{{ ex.created_at.strftime('%Y/%m/%d') if ex.created_at else 'N/A' }}</td>
                                    </td>
                                    <td>
                                        {% if ex.metrics %}
                                        {% for key, value in ex.metrics.items() %}
                                        {{ key.replace('_', ' ').capitalize() }}: {{ value }}<br>
                                        {% endfor %}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="text-muted text-center">No exercise data yet.</div>
                        {% endif %}
                    </div>
                </div>
                <!-- Add Goal Modal -->
                <div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('dashboard.index') }}">
                                {{ goal_form.hidden_tag() }} <div class="modal-header">
                                    <h5 class="modal-title" id="addGoalModalLabel">Add Goal</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-2">{{ goal_form.description.label }} {{
                                        goal_form.description(class="form-control") }}</div>
                                    <div class="mb-2">{{ goal_form.exercise_type.label }} {{
                                        goal_form.exercise_type(class="form-select") }}</div>
                                    <div class="mb-2">{{ goal_form.metric.label }} {{
                                        goal_form.metric(class="form-select") }}</div>
                                    <div class="mb-2">{{ goal_form.target_value.label }} {{
                                        goal_form.target_value(class="form-control") }}</div>
                                    <div class="mb-2">{{ goal_form.unit.label }} {{ goal_form.unit(class="form-control",
                                        readonly=True) }}</div>

                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary">{{ goal_form.submit(class="btn
                                            btn-primary") }}</button>
                                    </div>
                            </form>
                        </div>
                    </div>
                </div>





                {% else %}
                <div class="alert alert-info text-center">
                    <p>You are not logged in.</p>
                    <p>
                        <a href="{{ url_for('user.register') }}" class="btn btn-primary btn-sm">Register</a>
                        <a href="{{ url_for('user.login') }}" class="btn btn-outline-primary btn-sm">Login</a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>



</div>
{% endblock %}

{% block css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />

<style>
    body {
        background: #292a2c51 !important;
        /* light grey */
    }

    .card {
        border-radius: 1rem;
    }

    .chart-card {
        min-height: 400px;
        background: linear-gradient(135deg, #f8fafc 60%, #e0e7ef 100%);
    }

    .card-header.bg-light {
        background: #f8fafc !important;
        font-size: 1.1rem;
        border-bottom: 1px solid #e0e7ef;
    }

    .card-body .row {
        align-items: center;
    }

    .card-body .col-5 {
        font-weight: 500;
    }

    .card-body .col-7 {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .rounded-circle {
        border: 3px solid #0d6efd;
    }

    .btn-link {
        text-decoration: none;
    }

    .btn-link:hover {
        text-decoration: underline;
    }

    .btn-circle {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff86a;
        color: #222;
        border: none;
        font-size: 1.3rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        transition: background 0.2s;
    }

    .btn-circle:hover {
        background: #ffe066;
    }

    .btn-add {
        background: #fff86a;
        color: #222;
    }

    .btn-check {
        background: none;
        border: none;
        color: #bbb;
        font-size: 1.5rem;
        margin-top: 0.2rem;
    }

    .btn-check:hover {
        color: #0d6efd;
    }

    .btn-edit {
        background: none;
        border: none;
        color: #bbb;
        font-size: 1.3rem;
    }

    .btn-edit:hover {
        color: #0d6efd;
    }

    .achievement-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.3em;
        height: 2.3em;
        border-radius: 50%;
        font-size: 1.5em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        color: #fff;
        margin-right: 0.5em;
        border: 2.5px solid #fff;
        transition: transform 0.2s;
    }

    .achievement-icon:hover {
        transform: scale(1.1) rotate(-6deg);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
    }

    .schedule-item {
        border-radius: 1.2rem;
        padding: 0.7rem 1rem;
        background: #f8fafc;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
        transition: box-shadow 0.2s;
    }

    .schedule-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        background: #fffde7;
    }

    .goal-item {
        transition: background 0.2s;
    }

    .goal-item:hover {
        background: #fffde7 !important;
        /* light yellow */
    }

    .goal-item .delete-goal-form {
        display: none;
    }

    .goal-item:hover .delete-goal-form {
        display: block;
    }

    .give-up-badge-btn {
        cursor: pointer;
        font-weight: 500;
        padding: 0.2em 0.7em;
        margin-bottom: 0.1rem;
        margin-right: 0.1rem;
        background: #fff;
        color: #dc3545 !important;
        border: 1.5px solid #dc3545 !important;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
    }

    .give-up-badge-btn:hover {
        background: #ffe066 !important;
        color: #b30000 !important;
        border-color: #b30000 !important;
    }

    /* Make the calendar more compact and modern */
    #calendar {
        font-size: 0.95rem;
        padding: 0.5rem;
        background: #faf8f6 !important;
        border-radius: 1rem;
    }

    /* Remove grid lines */
    .fc-theme-standard .fc-scrollgrid,
    .fc-theme-standard td,
    .fc-theme-standard th {
        border: none !important;
        background: transparent !important;
    }

    /* Black day header letters (S M T W T F S) */
    .fc-col-header-cell-cushion {
        color: #222 !important;
        font-weight: 500;
        font-size: 1.1rem;
        letter-spacing: 0.05em;
        text-decoration: none;
    }

    /* Month/Year title at top left, bold, black */
    .fc-toolbar-title {
        font-size: 1.3rem !important;
        font-weight: 600;
        color: #222 !important;
        text-align: left !important;
        width: 100%;
        margin-bottom: 0.5rem;
    }

    /* Navigation arrows at top right */
    .fc-header-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.25rem;
        flex-direction: row;
        margin-bottom: 0.5rem;
    }

    /* Style navigation buttons */
    .fc .fc-button,
    .fc .fc-button-primary {
        display: flex !important;
        align-items: center;
        justify-content: center;
        background: #fff !important;
        border: none !important;
        color: #222 !important;
        box-shadow: none !important;
        border-radius: 50% !important;
        width: 2.2rem;
        height: 2.2rem;
        font-size: 1.2rem !important;
        transition: background 0.2s;
        padding: 0 !important;
    }

    .fc-button:hover,
    .fc-button-primary:hover {
        background: #f0f0f0 !important;
    }

    /* Remove cell hover/focus */
    .fc-daygrid-day-frame {
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Remove background from calendar */
    .fc {
        background: #faf8f6 !important;
        border-radius: 1rem;
        padding: 0.5rem;
    }

    .fc-daygrid-day {
        padding: 0 !important;
        margin: 0 !important;
        height: 2em !important;
        min-height: 2em !important;
        vertical-align: middle !important;
    }

    /* Remove extra space from the row */
    .fc-daygrid-row {
        min-height: 2em !important;
        height: 2em !important;
    }

    /* Make date numbers compact, centered, and today's highlight a perfect circle */
    .fc-daygrid-day-number {
        color: #222 !important;
        text-decoration: none !important;
        font-weight: 400;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2em;
        height: 2em;
        line-height: 2em;
        vertical-align: middle;
        font-size: 1rem;
        border-radius: 50%;
        margin: 0;
        padding: 0;
        transition: background 0.2s;
    }

    /* Highlight today as a filled yellow circle */
    .fc-day-today {
        background: none !important;
    }

    .fc-day-today .fc-daygrid-day-number {
        background: #fff86a !important;
        color: #222 !important;
        border-radius: 50% !important;
        font-weight: 500;
        box-shadow: none !important;
        text-decoration: none !important;
        border: none !important;
    }

    /* Fade out days from other months */
    .fc-day-other .fc-daygrid-day-number {
        color: #c0c0c0 !important;
        opacity: 0.7;
    }

    .fc-blue-circle .fc-daygrid-day-number {
        background: #339af0 !important;
        color: #fff !important;
        border-radius: 50% !important;
        font-weight: 600;
        box-shadow: 0 0 0 2px #e3f0fb;
        transition: background 0.2s;
    }

    /* Hide default event lines under the date number */
    .fc-daygrid-event-harness {
        display: none !important;
    }

    .weather-day-card {
        min-width: 80px;
        max-width: 90px;
        background: #f8fafc;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        border-radius: 0.75rem;
        margin-bottom: 0;
        padding: 0.5rem 0.25rem;
        transition: box-shadow 0.2s;
    }

    .weather-day-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        background: #e9f5ff;
    }

    .badge-bronze {
        background: linear-gradient(90deg, #cd7f32 60%, #b87333 100%);
        color: #fff;
        border: 1.5px solid #b87333;
        font-weight: 600;
        box-shadow: 0 1px 4px rgba(205, 127, 50, 0.08);
    }

    .badge-silver {
        background: linear-gradient(90deg, #c0c0c0 60%, #a9a9a9 100%);
        color: #fff;
        border: 1.5px solid #a9a9a9;
        font-weight: 600;
        box-shadow: 0 1px 4px rgba(192, 192, 192, 0.08);
    }

    .badge-gold {
        background: linear-gradient(90deg, #ffd700 60%, #ffb700 100%);
        color: #222;
        border: 1.5px solid #ffb700;
        font-weight: 700;
        box-shadow: 0 1px 4px rgba(255, 215, 0, 0.12);
    }

    .badge-locked {
        background: transparent;
        color: #bbb;
        border: 1.5px dashed #bbb;
        font-weight: 600;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.getElementById('avatar').addEventListener('change', function () {
        if (this.files.length > 0) {
            document.getElementById('avatar-form').submit();
        }
    });
    document.addEventListener('DOMContentLoaded', function () {
        const greetingLine = document.getElementById('greeting-line');
        if (greetingLine) {
            const hour = new Date().getHours();
            let greeting = "Hello";
            let emoji = "üëã";
            if (hour >= 5 && hour < 12) {
                greeting = "Good morning";
                emoji = "üåÖ";
            } else if (hour >= 12 && hour < 18) {
                greeting = "Good afternoon";
                emoji = "‚òÄÔ∏è";
            } else if (hour >= 18 && hour < 22) {
                greeting = "Good evening";
                emoji = "üåá";
            } else {
                greeting = "Good night";
                emoji = "üåô";
            }
            greetingLine.innerHTML = `<span>${emoji} ${greeting}, <strong>{{ current_user.nickname }}</strong></span>`;
        }
    });
</script>
<script>
    const intakeLabels = {{ intake_labels | tojson }};
    const intakeData = {{ intake_data | tojson }};
</script>
<script>
    function getLast14DaysLabels() {
        const labels = [];
        const today = new Date();
        for (let i = 13; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            labels.push(label);
        }
        return labels;
    }

    const labels = getLast14DaysLabels();

    const weight = [70.0, 69.9, 69.8, 69.7, 69.6, 69.5, 69.4, 69.3, 69.2, 69.1, 69.0, 68.9, 68.8, 68.7];

    const burnedLabels = {{ burned_labels | tojson }};
    const burnedData = {{ burned_data | tojson }};

    new Chart(document.getElementById('exerciseChart'), {
        type: 'bar',
        data: {
            labels: burnedLabels,
            datasets: [{
                label: 'Calories Burned',
                data: burnedData,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
    new Chart(document.getElementById('intakeChart'), {
        type: 'bar',
        data: {
            labels: intakeLabels,
            datasets: [{
                label: 'Calories Intake',
                data: intakeData,
                backgroundColor: 'rgba(255, 159, 64, 0.6)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('weightChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Weight (kg)',
                data: weight,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                fill: false,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: false, title: { display: true, text: 'kg' } } } }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            var events = JSON.parse('{{ calendar_events|tojson|safe }}');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 330,
                headerToolbar: {
                    start: 'title',
                    center: '',
                    end: 'prev,next'
                },
                buttonText: {
                    today: 'Today'
                },
                events: events,
                eventDisplay: 'auto',
                dayHeaders: true,
                dayHeaderFormat: { weekday: 'narrow' },
                eventDidMount: function (info) {
                    // Find the day cell
                    var dayCell = info.el.closest('.fc-daygrid-day');
                    if (dayCell) {
                        dayCell.classList.add('fc-blue-circle');
                        // Collect all events for this day
                        var dateStr = info.event.startStr;
                        var eventsForDay = info.view.calendar.getEvents().filter(function (ev) {
                            return ev.startStr === dateStr;
                        });
                        // Combine tooltips
                        var tooltip = eventsForDay.map(function (ev) {
                            return ev.extendedProps.tooltip;
                        }).join('\n');
                        // Set tooltip on the day cell (not just the event)
                        dayCell.setAttribute('title', tooltip);
                    }
                },
                eventContent: function (arg) {
                    return false;
                }
            });

            calendar.render();
            function updateTodayButton() {
                var todayBtn = calendarEl.querySelector('.fc-today-button');
                if (todayBtn) {
                    var today = new Date();
                    var weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
                    todayBtn.textContent = `Today (${weekday})`;
                }
            }
            updateTodayButton();
            calendar.on('datesSet', updateTodayButton);

        }
    });

</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const exerciseType = document.querySelector('[name="exercise_type"]');
        const metric = document.querySelector('[name="metric"]');
        const unit = document.querySelector('[name="unit"]');
        const metricsByType = JSON.parse('{{ metrics_by_type|tojson|safe }}');
        if (exerciseType && metric && unit) {
            exerciseType.addEventListener('change', function () {
                const metrics = metricsByType[this.value];
                metric.innerHTML = '';
                metrics.forEach(function (m) {
                    const opt = document.createElement('option');
                    opt.value = m[0];
                    opt.textContent = m[0].replace('_', ' ').toUpperCase();
                    metric.appendChild(opt);
                });
                unit.value = metrics[0][1];
            });
            metric.addEventListener('change', function () {
                const metrics = metricsByType[exerciseType.value];
                const selected = metrics.find(m => m[0] === this.value);
                if (selected) unit.value = selected[1];
            });
        }
    });

</script>

{% endblock %}