{% extends "base.html" %}

{% block title %}
    Dashboard
{% endblock %}

{% set perth = pytz.timezone('Australia/Perth') %}

{% block css %}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/index.css') }}"/>
{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="row">
                    <!-- User Info Left -->
                    <div class="col-lg-3 mb-4">
                        <div class="card shadow-lg border-0 h-100">
                            <div class="card-body">
                                <form id="avatar-form" action="{{ url_for('user.upload_avatar') }}" method="post"
                                      enctype="multipart/form-data" class="mt-2 mb-3 text-center">
                                    <label for="avatar" style="cursor:pointer; display:block;">
                                        {% if current_user.avatar %}
                                            <img src="{{ url_for('static', filename=current_user.avatar) }}"
                                                 alt="Avatar"
                                                 class="rounded-circle shadow mb-3" width="96" height="96"
                                                 id="avatar-img">
                                        {% else %}
                                            <img src="https://ui-avatars.com/api/?name={{ current_user.nickname|default('User') }}&size=96&background=0D8ABC&color=fff"
                                                 alt="Default Avatar" class="rounded-circle shadow mb-3" width="96"
                                                 height="96"
                                                 id="avatar-img">
                                        {% endif %}
                                    </label>
                                    <input type="file" name="avatar" id="avatar" accept="image/*" style="display:none"
                                           required>
                                </form>
                                <h2 class="card-title mb-1 text-center" id="greeting-line">
                                    <strong>{{ current_user.nickname }}</strong></h2>
                                <div class="card mb-3 shadow-sm border-0">
                                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                        <strong>Personal Information</strong>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row mb-2">
                                            <div class="col-5 text-muted"><strong>Username:</strong></div>
                                            <div class="col-7">{{ current_user.username }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-5 text-muted"><strong>Email:</strong></div>
                                            <div class="col-7">{{ current_user.email }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-5 text-muted"><strong>Date of Birth:</strong></div>
                                            <div class="col-7">{{ current_user.date_of_birth or 'N/A' }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-5 text-muted"><strong>Sex:</strong></div>
                                            <div class="col-7">{{ current_user.sex or 'N/A' }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-5 text-muted"><strong>Created At:</strong></div>
                                            <div class="col-7">
                                                {{ current_user.created_at.astimezone(perth).strftime('%Y-%m-%d %H:%M') if
                                            current_user.created_at else 'N/A' }}
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-5 text-muted"><strong>Last Login:</strong></div>
                                            <div class="col-7">
                                                {{ current_user.last_login.astimezone(perth).strftime('%Y-%m-%d %H:%M') if
                                            current_user.last_login else 'N/A' }}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Weather Forecast Card START -->
                                    <div class="card mb-4 shadow-sm border-0">
                                        <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                            <strong>Weather Forecast (Next 5 Days)</strong>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between flex-nowrap overflow-auto gap-2">
                                                {% for day in weather_forecast %}
                                                    <div
                                                            class="weather-day-card flex-shrink-0 text-center p-2 border rounded bg-light">
                                                        <div class="fw-bold"
                                                             style="font-size: 1rem;">{{ day.date }}</div>
                                                        <div>
                                                            <img src="{{ day.icon_url }}" alt="weather" width="28"
                                                                 height="28">
                                                        </div>
                                                        <div style="font-size: 1rem;">{{ day.temp }}¬∞C</div>
                                                        <div class="text-muted"
                                                             style="font-size:0.85em;">{{ day.description }}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Weather Forecast Card END -->

                                    <!-- Calendar Card START -->
                                    <div class="card mb-4 shadow-sm border-0">
                                        <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                            <strong>Calendar</strong>
                                        </div>
                                        <div class="card-body p-3">
                                            <div id="calendar"></div>
                                        </div>
                                    </div>
                                    <!-- Calendar Card END -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Achievements Card START -->
                    <div class="col-lg-5 mb-4">
                        <div class="row g-4">
                            <div class="col-md-12">
                                <div class="card chart-card shadow-sm border-0 mb-4">
                                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                        <strong>Achievements</strong>
                                    </div>
                                    <div class="card-body p-3">
                                        {% if achievements_by_type %}
                                            <div id="achievements-list">
                                                {% set icons = {
                                                'running': 'üèÉ‚Äç‚ôÇÔ∏è',
                                                'cycling': 'üö¥‚Äç‚ôÄÔ∏è',
                                                'swimming': 'üèä‚Äç‚ôÇÔ∏è',
                                                'weight_lifting': 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
                                                'yoga': 'üßò‚Äç‚ôÇÔ∏è'
                                                } %}
                                                {% set icon_colors = {
                                                'running': '#ffb700',
                                                'cycling': '#00b894',
                                                'swimming': '#0984e3',
                                                'weight_lifting': '#636e72',
                                                'yoga': '#a29bfe'
                                                } %}
                                                {% set units = {
                                                'running': 'M',
                                                'cycling': 'M',
                                                'swimming': 'M',
                                                'weight_lifting': 'KG',
                                                'yoga': 'MIN'
                                                } %}
                                                {% set badge_classes = ['badge-bronze', 'badge-silver', 'badge-gold'] %}
                                                {% set badge_labels = ['Bronze', 'Silver', 'Gold'] %}
                                                {% for ex_type, milestones in all_achievements.items() %}
                                                    <div class="mb-2 d-flex align-items-center">
                                                        <span class="achievement-icon me-2"
                                                              style="background: {{ icon_colors[ex_type.value] }};">
                                                            {{ icons[ex_type.value] }}
                                                        </span>
                                                        <strong style="font-size:1.1em;">{{ ex_type }}</strong>:
                                                        <span class="ms-2">
                                                            {% for milestone in milestones %}
                                                                {% set idx = loop.index0 %}
                                                                {% set badge_label = badge_labels[idx] %}
                                                                {% if milestone in achievements_by_type[ex_type] %}
                                                                    {% set badge_class = badge_classes[idx] %}
                                                                {% else %}
                                                                    {% set badge_class = 'badge-locked' %}
                                                                {% endif %}
                                                                <span class="badge {{ badge_class }} me-1"
                                                                      title="{{ badge_label }}">
                                                                    {{ badge_label }}
                                                                    {% if units[ex_type.value] == "M" %}
                                                                        {{ (milestone/1000)|int }}KM
                                                                    {% else %}
                                                                        {{ milestone|int }}{{ units[ex_type.value] }}
                                                                    {% endif %}
                                                                </span>
                                                            {% endfor %}
                                                        </span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="text-muted text-center">No achievements yet. Start logging your
                                                activities!
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <!-- Achievements Card END -->


                            <div class="col-md-12">
                                <div class="card chart-card shadow-sm border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title text-center">Calories Burned</h5>
                                        <canvas id="exerciseChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card chart-card shadow-sm border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title text-center">Calorie Intake</h5>
                                        <canvas id="intakeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card chart-card shadow-sm border-0">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center"
                                         style="border-radius: 1rem 1rem 0 0;">
                                        <strong>Weight Trend</strong>
                                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                                data-bs-target="#editWeightModal">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="weightChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade" id="editWeightModal" tabindex="-1"
                                 aria-labelledby="editWeightModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form method="POST" action="{{ url_for('browse.body_measurement') }}">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editWeightModalLabel">Edit Weight</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" name="referrer"
                                                       value="{{ url_for('dashboard.index') }}">
                                                {{ body_measurement_form.hidden_tag() }}
                                                {{ body_measurement_form.type(class="d-none", value="WEIGHT") }}
                                                <div class="mb-3">
                                                    {{ body_measurement_form.value.label(class="form-label", text="Weight (KG)") }}
                                                    {{ body_measurement_form.value(class="form-control") }}
                                                </div>
                                                <div class="mb-3">
                                                    {{ body_measurement_form.date.label(class="form-label") }}
                                                    {{ body_measurement_form.date(class="form-control") }}
                                                </div>
                                                <div class="mb-3">
                                                    {{ body_measurement_form.time.label(class="form-label") }}
                                                    {{ body_measurement_form.time(class="form-control") }}
                                                </div>
                                                <div class="mb-3">
                                                    {{ body_measurement_form.timezone.label(class="form-label") }}
                                                    {{ body_measurement_form.timezone(class="form-select") }}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-primary">Save</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Schedule & Goals -->
                    <div class="col-lg-4 mb-4">
                        <!-- Schedule Card -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>My Schedule</strong>
                                <!-- Add Button (opens modal) -->
                                <button class="btn btn-circle btn-add" data-bs-toggle="modal"
                                        data-bs-target="#addScheduleModal">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-2 text-muted">
                                    {{ now.strftime('%A, %d %b %y') }}
                                </div>
                                {% if current_user.scheduled_exercises.all() %}
                                    <ul class="list-unstyled">
                                        {% for ex in current_user.scheduled_exercises %}
                                            <li class="schedule-item d-flex align-items-start mb-3">
                                                <button class="btn btn-check me-3" title="Mark as done">
                                                    <i class="bi bi-circle"></i>
                                                </button>
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold" style="font-size:1.1rem;">
                                                        {{ ex.exercise_type }}
                                                    </div>
                                                    <div class="text-muted small">
                                                        {{ ex.day_of_week }} {{ ex.scheduled_time.strftime('%I:%M %p').lstrip('0') }}
                                                        {% if ex.note %} <br/> {{ ex.note }}{% endif %}
                                                    </div>
                                                </div>
                                                <!-- Edit button -->
                                                <button class="btn btn-edit ms-2" title="Edit" data-bs-toggle="modal"
                                                        data-bs-target="#editScheduleModal-{{ ex.id }}">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                                <!-- Edit Modal for each schedule item -->
                                                <div class="modal fade" id="editScheduleModal-{{ ex.id }}" tabindex="-1"
                                                     aria-labelledby="editScheduleModalLabel-{{ ex.id }}"
                                                     aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <form method="POST"
                                                                  action="{{ url_for('dashboard.edit_schedule', id=ex.id) }}">
                                                                {{ schedule_form.hidden_tag() }}
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title"
                                                                        id="editScheduleModalLabel-{{ ex.id }}">
                                                                        Edit or Delete Exercise</h5>
                                                                    <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"
                                                                            aria-label="Close"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <div class="mb-2">
                                                                        <label>Day</label>
                                                                        <select name="day_of_week" class="form-select">
                                                                            {% for val, label in schedule_form.day_of_week.choices %}
                                                                                <option value="{{ val }}"
                                                                                        {% if ex.day_of_week==val %}selected{% endif %}>{{ label }}</option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label>Exercise</label>
                                                                        <select name="exercise_type"
                                                                                class="form-select">
                                                                            {% for val, label in schedule_form.exercise_type.choices %}
                                                                                <option value="{{ val }}" {% if
                                                                    ex.exercise_type.value==val or ex.exercise_type==val %}selected{% endif %}>{{ label }}</option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label>Time</label>
                                                                        <input type="time" name="scheduled_time"
                                                                               class="form-control"
                                                                               value="{{ ex.scheduled_time.strftime('%H:%M') }}">
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <label>Note</label>
                                                                        <input type="text" name="note"
                                                                               class="form-control"
                                                                               value="{{ ex.note }}">
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer d-flex justify-content-between">
                                                                    <button type="submit" class="btn btn-primary">Save
                                                                        Changes
                                                                    </button>
                                                            </form>
                                                            <form method="POST"
                                                                  action="{{ url_for('dashboard.delete_schedule', id=ex.id) }}"
                                                                  onsubmit="return confirm('Delete this schedule?');">
                                                                <button type="submit" class="btn btn-danger">Delete
                                                                </button>
                                                            </form>
                                                        </div>

                                                    </div>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="text-muted">No scheduled exercises.</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Add Schedule Modal -->
                        <div class="modal fade" id="addScheduleModal" tabindex="-1"
                             aria-labelledby="addScheduleModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form method="POST" action="{{ url_for('dashboard.add_schedule') }}">
                                        {{ schedule_form.hidden_tag() }}
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="addScheduleModalLabel">Add Exercise</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-2">{{ schedule_form.day_of_week.label }} {{ schedule_form.day_of_week(class="form-select") }}</div>
                                            <div class="mb-2">{{ schedule_form.exercise_type.label }} {{ schedule_form.exercise_type(class="form-select") }}</div>
                                            <div class="mb-2">{{ schedule_form.scheduled_time.label }} {{ schedule_form.scheduled_time(class="form-control") }}</div>
                                            <div class="mb-2">{{ schedule_form.note.label }} {{ schedule_form.note(class="form-control") }}
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">{{ schedule_form.submit(class="btn
                                        btn-primary") }}</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!-- Goals Card -->
                        <!-- Goals List Card -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>My Goals</strong>
                                <button class="btn btn-circle btn-add" data-bs-toggle="modal"
                                        data-bs-target="#addGoalModal">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                {% if current_user.goals.all() %}
                                    <ul class="list-group">
                                        {% for goal in current_user.goals %}
                                            <li
                                                    class="list-group-item d-flex justify-content-between align-items-center position-relative goal-item">
                                <span>
                                    <strong>{{ goal.description }}</strong>
                                    <br>
                                    <span class="text-muted">
                                        {{ goal.exercise_type }}
                                    </span>
                                    <br>
                                    Target: {{ goal.target_value }} {{ goal.unit }}
                                </span>

                                                <span class="d-flex flex-column align-items-end">
                                    {% if goal.current_value >= goal.target_value %}
                                        <span class="badge bg-success rounded-pill mb-2">
                                        Completed <i class="bi bi-check-circle-fill ms-1"></i>
                                    </span>
                                        <form method="POST" action="{{ url_for('dashboard.delete_goal', id=goal.id) }}"
                                              onsubmit="return confirm('Are you sure you want to delete this completed goal?');"
                                              class="delete-goal-form">
                                        <button type="submit"
                                                class="badge rounded-pill bg-white text-danger border border-danger give-up-badge-btn"
                                                style="font-size: 0.8rem;" title="Delete Goal">
                                            Delete
                                        </button>
                                    </form>
                                    {% else %}
                                        {% if goal.current_value > 0 %}
                                            <span class="badge bg-warning text-dark rounded-pill mb-2">
                                        In Progress: {{ goal.current_value }} / {{ goal.target_value }}
                                    </span>
                                        {% else %}
                                            <span class="badge bg-primary rounded-pill mb-2">
                                        {{ goal.current_value }} / {{ goal.target_value }}
                                    </span>
                                        {% endif %}
                                        <form method="POST" action="{{ url_for('dashboard.delete_goal', id=goal.id) }}"
                                              onsubmit="return confirm('Are you sure you want to give up this goal?');"
                                              class="delete-goal-form">
                                        <button type="submit"
                                                class="badge rounded-pill bg-white text-danger border border-danger give-up-badge-btn"
                                                style="font-size: 0.8rem;" title="Give Up Goal">
                                            Give Up
                                        </button>
                                    </form>
                                    {% endif %}
                                </span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="text-muted">No goals set yet.</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- BMI Chart Card -->
                        <div class="card chart-card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light">
                                <strong>BMI</strong>
                            </div>
                            <div class="card-body text-center">
                                <div style="font-size:1.3rem;">
                                    Current BMI={{ bmi if bmi is not none else 'N/A' }}
                                </div>
                                <div style="color: #bfa000; font-weight:600;">
                                    {{ bmi_category or '' }}
                                </div>
                                <div class="bmi-bar-container my-3" style="position:relative; height:48px;">
                                    <canvas id="bmiBar" width="400" height="48"></canvas>
                                </div>
                                <div class="d-flex justify-content-between" style="font-size:0.95rem;">
                                    <span>15</span>
                                    <span>18.5</span>
                                    <span>25</span>
                                    <span>30</span>
                                    <span>40</span>
                                </div>
                            </div>
                        </div>
                        <!-- Exercise Log Card -->
                        <div class="card chart-card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                                <strong>Exercise Log</strong>
                            </div>
                            <div class="card-body p-3">
                                {% if current_user.exercises %}
                                    <table class="table table-striped">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Details</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for ex in current_user.exercises[:10] %}
                                            <tr>
                                                <td>{{ loop.index }}</td>
                                                <td>{{ ex.type }}</td>
                                                <td>{{ ex.created_at.strftime('%Y/%m/%d') if ex.created_at else 'N/A' }}</td>
                                                </td>
                                                <td>
                                                    {% if ex.metrics %}
                                                        {% for key, value in ex.metrics.items() %}
                                                            {{ key.replace('_', ' ').capitalize() }}: {{ value }}<br>
                                                        {% endfor %}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <div class="text-muted text-center">No exercise data yet.</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Add Goal Modal -->
                        <div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form method="POST" action="{{ url_for('dashboard.add_goal') }}">
                                        {{ goal_form.hidden_tag() }}
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="addGoalModalLabel">Add Goal</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-2">{{ goal_form.description.label }} {{ goal_form.description(class="form-control") }}</div>
                                            <div class="mb-2">{{ goal_form.exercise_type.label }} {{ goal_form.exercise_type(class="form-select") }}</div>
                                            <div class="mb-2">{{ goal_form.metric.label }} {{ goal_form.metric(class="form-select") }}</div>
                                            <div class="mb-2">{{ goal_form.target_value.label }} {{ goal_form.target_value(class="form-control") }}</div>
                                            <div class="mb-2">{{ goal_form.unit.label }} {{ goal_form.unit(class="form-control",
                                        readonly=True) }}</div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-primary">{{ goal_form.submit(class="btn
                                            btn-primary") }}</button>
                                            </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
{% endblock %}

{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.getElementById("avatar").addEventListener("change", function () {
            if (this.files.length > 0) {
                document.getElementById("avatar-form").submit()
            }
        })
        document.addEventListener("DOMContentLoaded", function () {
            const greetingLine = document.getElementById("greeting-line")
            if (greetingLine) {
                const hour = new Date().getHours()
                let greeting = "Hello"
                let emoji = "üëã"
                if (hour >= 5 && hour < 12) {
                    greeting = "Good morning"
                    emoji = "üåÖ"
                } else if (hour >= 12 && hour < 18) {
                    greeting = "Good afternoon"
                    emoji = "‚òÄÔ∏è"
                } else if (hour >= 18 && hour < 22) {
                    greeting = "Good evening"
                    emoji = "üåá"
                } else {
                    greeting = "Good night"
                    emoji = "üåô"
                }
                greetingLine.innerHTML = `<span>${emoji} ${greeting}, <strong>{{ current_user.nickname }}</strong></span>`
            }
        })
    </script>
    <script>
        function getLast14DaysLabels() {
            const labels = []
            const today = new Date()
            for (let i = 13; i >= 0; i--) {
                const date = new Date(today)
                date.setDate(today.getDate() - i)
                const label = date.toLocaleDateString()
                labels.push(label)
            }
            return labels
        }

        const UserBodyMeasurements = {{ current_user.body_measurements_to_list() | tojson }}
        const UserWeightByDate = Object.fromEntries(getLast14DaysLabels().map(key => [key, null]))
        UserBodyMeasurements.forEach(measurement => {
            if (measurement.type !== "WEIGHT") return
            const date = new Date(measurement.created_at).toLocaleDateString()
            if (UserWeightByDate[date] === null) {
                UserWeightByDate[date] = measurement.value
            }
        })

        const UserCalorieBurnedByDate = {{ burned_by_date | tojson }}

        const UserCalorieIntakes = {{ current_user.calorie_intakes_to_list() | tojson }}
        const UserCalorieIntakeByDate = {}
        UserCalorieIntakes.forEach(intake => {
            const date = new Date(intake.created_at).toLocaleDateString()
            if (!UserCalorieIntakeByDate[date]) {
                UserCalorieIntakeByDate[date] = 0
            }
            UserCalorieIntakeByDate[date] += intake.calories
        })

        new Chart(document.getElementById("exerciseChart"), {
            type: "bar",
            data: {
                labels: Object.keys(UserCalorieBurnedByDate).map(date => new Date(date).toLocaleDateString()),
                datasets: [{
                    label: "Calories Burned",
                    data: Object.values(UserCalorieBurnedByDate),
                    backgroundColor: "rgba(75, 192, 192, 0.6)",
                    borderColor: "rgba(75, 192, 192, 1)",
                    borderWidth: 1
                }]
            },
            options: {responsive: true, scales: {y: {beginAtZero: true}}}
        })
        new Chart(document.getElementById("intakeChart"), {
            type: "bar",
            data: {
                labels: Object.keys(UserCalorieIntakeByDate),
                datasets: [{
                    label: "Calories Intake",
                    data: Object.values(UserCalorieIntakeByDate),
                    backgroundColor: "rgba(255, 159, 64, 0.6)",
                    borderColor: "rgba(255, 159, 64, 1)",
                    borderWidth: 1
                }]
            },
            options: {responsive: true, scales: {y: {beginAtZero: true}}}
        })

        new Chart(document.getElementById("weightChart"), {
            type: "line",
            data: {
                labels: Object.keys(UserWeightByDate),
                datasets: [{
                    label: "Weight (kg)",
                    data: Object.values(UserWeightByDate),
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    fill: false,
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: "rgba(54, 162, 235, 1)"
                }]
            },
            options: {
                responsive: true,
                scales: {y: {beginAtZero: false, title: {display: true, text: "kg"}}},
                spanGaps: true // <-- Move spanGaps here
            }

        })
    </script>
    <script>
        function getNextDateForDay(dayName) {
            const dayMap = {
                "sunday": 0,
                "monday": 1,
                "tuesday": 2,
                "wednesday": 3,
                "thursday": 4,
                "friday": 5,
                "saturday": 6
            }

            const targetDay = dayName.toLowerCase()
            const targetIdx = dayMap[targetDay]

            if (targetIdx === undefined) {
                throw new Error(`Invalid day name: ${dayName}`)
            }

            const today = new Date()
            const todayIdx = today.getDay() // 0-6 (Sunday=0)

            let delta = targetIdx - todayIdx
            if (delta <= 0) {
                delta += 7
            }

            const nextDate = new Date(today)
            nextDate.setDate(today.getDate() + delta)
            return nextDate
        }

        const UserScheduledExercises = {{ current_user.scheduled_exercises_to_list()|tojson }}
        const calendar_events = []
        UserScheduledExercises.forEach(event => {
            calendar_events.push({
                title: "",
                start: getNextDateForDay(event.day_of_week),
                color: "#b3d8fd",
                extendedProps: {
                    "tooltip": event.exercise_type
                }
            })
        })
        document.addEventListener("DOMContentLoaded", function () {
            const calendarEl = document.getElementById("calendar")
            if (calendarEl) {
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: "dayGridMonth",
                    height: 330,
                    headerToolbar: {
                        start: "title",
                        center: "",
                        end: "prev,next"
                    },
                    buttonText: {
                        today: "Today"
                    },
                    events: calendar_events,
                    eventDisplay: "auto",
                    dayHeaders: true,
                    dayHeaderFormat: {weekday: "narrow"},
                    eventDidMount: function (info) {
                        // Find the day cell
                        const dayCell = info.el.closest(".fc-daygrid-day")
                        if (dayCell) {
                            dayCell.classList.add("fc-blue-circle")
                            // Collect all events for this day
                            const dateStr = info.event.startStr
                            const eventsForDay = info.view.calendar.getEvents().filter(function (ev) {
                                return ev.startStr === dateStr
                            })
                            // Combine tooltips
                            var tooltip = eventsForDay.map(function (ev) {
                                return ev.extendedProps.tooltip
                            }).join("\n")
                            // Set tooltip on the day cell (not just the event)
                            dayCell.setAttribute("title", tooltip)
                        }
                    },
                    eventContent: function (arg) {
                        return false
                    }
                })

                calendar.render()

                function updateTodayButton() {
                    const todayBtn = calendarEl.querySelector(".fc-today-button")
                    if (todayBtn) {
                        const today = new Date()
                        const weekday = today.toLocaleDateString("en-US", {weekday: "short"})
                        todayBtn.textContent = `Today (${weekday})`
                    }
                }

                updateTodayButton()
                calendar.on("datesSet", updateTodayButton)

            }
        })

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Only target the Add Goal modal
            const addGoalModal = document.getElementById("addGoalModal")
            if (!addGoalModal) return
            addGoalModal.addEventListener("shown.bs.modal", function () {
                const exerciseType = addGoalModal.querySelector("[name=\"exercise_type\"]")
                const metric = addGoalModal.querySelector("[name=\"metric\"]")
                const unit = addGoalModal.querySelector("[name=\"unit\"]")
                const metricsByType = {{ metrics_by_type|tojson }};

                function getUnit(metric) {
                    switch (metric) {
                        case "distance":
                            return "m"
                        case "duration":
                            return "min"
                        case "weight":
                            return "kg"
                        default:
                            return ""
                    }
                }

                function updateMetricAndUnit() {
                    const metrics = metricsByType[exerciseType.value] || []
                    metric.innerHTML = ""
                    metrics.forEach(function (m) {
                        const opt = document.createElement("option")
                        opt.value = m
                        opt.textContent = m.charAt(0).toUpperCase() + m.slice(1)
                        metric.appendChild(opt)
                    })
                    if (metrics.length > 0) {
                        unit.value = getUnit(metrics[0])
                    } else {
                        unit.value = ""
                    }
                }

                if (exerciseType && metric && unit) {
                    exerciseType.addEventListener("change", updateMetricAndUnit)
                    metric.addEventListener("change", function () {
                        const metrics = metricsByType[exerciseType.value] || []
                        const selected = metrics.find(m => m === this.value)
                        if (selected) {
                            unit.value = getUnit(selected)
                        }
                    })
                    // Run on modal open
                    updateMetricAndUnit()
                }
            })
        })
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const bmi = {{ bmi| tojson
    }};
            const bmiBar = document.getElementById("bmiBar")
            if (bmiBar) {
                const ctx = bmiBar.getContext("2d")
                // Draw colored ranges
                const ranges = [
                    {min: 15, max: 18.5, color: "#4fc3f7"}, // Underweight
                    {min: 18.5, max: 25, color: "#81c784"}, // Normal
                    {min: 25, max: 30, color: "#ffe066"},   // Overweight
                    {min: 30, max: 40, color: "#ffb74d"}    // Obesity
                ]
                const width = bmiBar.width, height = bmiBar.height
                ranges.forEach(r => {
                    const x1 = ((r.min - 15) / 25) * width
                    const x2 = ((r.max - 15) / 25) * width
                    ctx.fillStyle = r.color
                    ctx.fillRect(x1, 0, x2 - x1, height)
                })
                // Draw pointer for user's BMI if available and in range
                if (bmi !== null && !isNaN(bmi) && bmi >= 15 && bmi <= 40) {
                    const x = ((bmi - 15) / 25) * width
                    ctx.beginPath()
                    ctx.moveTo(x, 0)
                    ctx.lineTo(x - 7, height)
                    ctx.lineTo(x + 7, height)
                    ctx.closePath()
                    ctx.fillStyle = "#f44336"
                    ctx.fill()
                }
            }
        })
    </script>

{% endblock %}