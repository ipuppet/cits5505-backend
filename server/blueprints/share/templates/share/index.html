{% extends "base.html" %}

{% block title %}
Share Data
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center align-items-start">
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                    <h4 class="mb-0">Share with Friends</h4>
                    <div class="text-muted small mt-1">Current User: {{ current_user.nickname }} ({{ current_user.username }})</div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="searchFriend" class="form-label">Search Friends</label>
                        <input type="text" id="searchFriend" class="form-control" placeholder="Search friends...">
                    </div>
                    <form id="friendShareForm" action="{{ url_for('share.create_share') }}" method="post" onsubmit="updateScopeHidden()">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            <label for="friendacSelect" class="form-label">Select Friend</label>
                            <select id="friendacSelect" class="form-select" name="receiver_id" size="5">
                                <!-- Dynamic friend options will be inserted here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="timeRange">Time Range</label>
                            <select id="timeRange" class="form-select" name="shareDays" required>
                                <option value="" disabled selected>Please select days</option>
                                <option value="1">1 day</option>
                                <option value="2">2 days</option>
                                <option value="3">3 days</option>
                                <option value="4">4 days</option>
                                <option value="5">5 days</option>
                                <option value="6">6 days</option>
                                <option value="7">7 days</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" id="start_date" name="start_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" id="end_date" name="end_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="chartType" class="form-label">Data Type</label>
                            <select id="chartType" class="form-select" required>
                                <option value="" disabled selected>Please select a data type</option>
                                <option value="exercise">Exercise</option>
                                <option value="calorie">Calorie Intake</option>
                                <option value="measurement">Body Measurement</option>
                                <option value="achievement">Achievement</option>
                            </select>
                        </div>
                        <div id="subTypeCheckboxes" class="mb-3"></div>
                        <div id="chartPreview" class="my-3"></div>
                        <input type="hidden" id="scopeHidden" name="scope" value='{"exercise_types":[],"body_measurement_types":[],"achievements":[],"start_date":"","end_date":""}'>
                        <button type="submit" class="btn btn-primary">Share Data</button>
                    </form>
                    <div id="sendStatus" class="mt-3 text-success" style="display:none;">Data shared successfully with selected friends.</div>
                </div>
            </div>
        </div>
        <!-- Right Column: Share Records -->
        <div class="col-lg-7 mb-4 d-flex flex-column gap-4">
            <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                <div class="card-header bg-light d-flex justify-content-between align-items-center" style="border-radius: 1rem 1rem 0 0;">
                    <h4 class="mb-0">Share Records</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Sent Shares</h5>
                                <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#sentSharesModal">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div id="shareSent"></div>
                            <div id="sentCountText" class="text-muted mt-2">You have shared 0 records.</div>
                        </div>
                        <hr class="my-2" style="border-top: 1px solid #e0e7ef; opacity: 1;">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Received Shares</h5>
                                <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#receivedSharesModal">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div id="shareReceived"></div>
                            <div id="receivedCountText" class="text-muted mt-2">You have received 0 records.</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 新增：分享数据预览卡片 -->
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                        <h4 class="mb-0">Preview Data to Share</h4>
                    </div>
                    <div class="card-body p-3">
                        <table class="table table-striped" id="sharePreviewTable">
                            <thead>
                            <tr id="sharePreviewHeader">
                                <!-- 动态插入表头 -->
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态插入预览数据 -->
                            </tbody>
                        </table>
                        <div id="sharePreviewEmpty" class="text-muted text-center" style="display:none;">No data to preview. Please select data type and time range.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sent Shares Modal -->
<div class="modal fade" id="sentSharesModal" tabindex="-1" aria-labelledby="sentSharesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sentSharesModalLabel">All Sent Shares</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="sentSharesDetail"></div>
            </div>
        </div>
    </div>
</div>
<!-- Received Shares Modal -->
<div class="modal fade" id="receivedSharesModal" tabindex="-1" aria-labelledby="receivedSharesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receivedSharesModalLabel">All Received Shares</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="receivedSharesDetail"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<style>
    body {
        background: #292a2c51 !important;
    }
    .card {
        border-radius: 1rem !important;
        margin-bottom: 1rem;
    }
    .card-header.bg-light {
        background: #f8fafc !important;
        font-size: 1.15rem;
        font-weight: 600;
        border-bottom: 1px solid #e0e7ef;
        letter-spacing: 0.01em;
    }
    .btn-circle {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff86a;
        color: #222;
        border: none;
        font-size: 1.3rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        transition: background 0.2s;
    }
    .btn-circle:hover {
        background: #ffe066;
    }
    .btn-add {
        background: #fff86a;
        color: #222;
    }
    .btn-copy {
        font-size: 1rem;
        margin-left: 1rem;
    }
    .card h4, .card h5 {
        font-size: 1.15rem;
        font-weight: 600;
    }
    .form-control, .form-select {
        border-radius: 0.7rem;
    }
    .form-text {
        color: #888;
    }
    .input-group .form-control {
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block js %}
{{ super() }}
<script>
    // 将所有DOM操作和事件绑定放在DOMContentLoaded事件中
    window.addEventListener('DOMContentLoaded', () => {
        // Remove multi-select friends logic, only keep single select
        // Search and render dropdown
        document.getElementById('searchFriend').addEventListener('input', function() {
            const username = this.value.trim();
            const friendSelect = document.getElementById('friendacSelect');
            friendSelect.innerHTML = '';
            if (!username) return;
            fetch(`/user/${encodeURIComponent(username)}`)
                .then(res => res.json())
                .then(res => {
                    if (res.code === 1 && Array.isArray(res.data)) {
                        res.data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.text = user.nickname ? `${user.nickname}（${user.username}）` : user.username;
                            friendSelect.appendChild(option);
                        });
                    }
                });
        });
        // Remove selectedFriends and related logic
        // Remove form submit handler for selectedFriends

        // Fetch and render share records from backend
        fetch('/static/share/share_records.json')
            .then(response => response.json())
            .then(data => {
                const shareSent = document.getElementById('shareSent');
                const shareReceived = document.getElementById('shareReceived');
                shareSent.innerHTML = '';
                shareReceived.innerHTML = '';
                data.share_sent.forEach(record => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${record.receiver_name}</h5>
                            <p class="card-text">${record.message}</p>
                            <button class="btn btn-danger" onclick="deleteShareRecord(${record.id})">Delete</button>
                        </div>
                    `;
                    shareSent.appendChild(card);
                });
                data.share_received.forEach(record => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${record.sender_name}</h5>
                            <p class="card-text">${record.message}</p>
                        </div>
                    `;
                    shareReceived.appendChild(card);
                });
                // Update share count text dynamically
                const sentCountText = document.getElementById('sentCountText');
                if (sentCountText) {
                    sentCountText.textContent = `You have successfully shared ${data.share_sent.length} records.`;
                }
                const receivedCountText = document.getElementById('receivedCountText');
                if (receivedCountText) {
                    receivedCountText.textContent = `You have received ${data.share_received.length} records.`;
                }
            });

        // Listen for modal display and load data dynamically
        const sentModal = document.getElementById('sentSharesModal');
        sentModal && sentModal.addEventListener('show.bs.modal', function () {
            fetch('/static/share/share_records.json')
                .then(response => response.json())
                .then(data => renderSharesDetail('sent', data.share_sent));
        });
        const receivedModal = document.getElementById('receivedSharesModal');
        receivedModal && receivedModal.addEventListener('show.bs.modal', function () {
            fetch('/static/share/share_records.json')
                .then(response => response.json())
                .then(data => renderSharesDetail('received', data.share_received));
        });

        // Add updateScopeHidden function and event binding
        function updateScopeHidden() {
            // Get date values
            var startDate = document.getElementById('start_date').value;
            var endDate = document.getElementById('end_date').value;
            
            // Get selected exercise types
            var exerciseTypes = Array.from(document.querySelectorAll('input[name="exerciseType"]:checked'))
                .map(checkbox => checkbox.value);
                
            // Get selected body measurement types
            var bodyMeasurementTypes = Array.from(document.querySelectorAll('input[name="measurementType"]:checked'))
                .map(checkbox => checkbox.value);
                
            // Get selected achievement types
            var achievements = Array.from(document.querySelectorAll('input[name="achievementType"]:checked'))
                .map(checkbox => checkbox.value);
                
            // Assemble scope object
            var scope = {
                exercise_types: exerciseTypes,
                body_measurement_types: bodyMeasurementTypes,
                achievements: achievements,
                start_date: startDate,
                end_date: endDate
            };
            
            // Update hidden field value
            document.getElementById('scopeHidden').value = JSON.stringify(scope);
        }

        // Add event listeners for all elements that might affect scope
        document.getElementById('start_date').addEventListener('change', updateScopeHidden);
        document.getElementById('end_date').addEventListener('change', updateScopeHidden);
        
        // Add event delegation for checkbox container
        document.getElementById('subTypeCheckboxes').addEventListener('change', function(e) {
            if (e.target.matches('input[type="checkbox"]')) {
                updateScopeHidden();
            }
        });

        // Dynamically render checkboxes
        document.getElementById('chartType').addEventListener('change', function() {
            var value = this.value;
            var container = document.getElementById('subTypeCheckboxes');
            container.innerHTML = '';
            if (value === 'exercise') {
                const options = ['Cycling', 'Running', 'Swimming', 'Weight Lifting', 'Yoga'];
                options.forEach(opt => {
                    const id = 'exercise_' + opt.replace(/\s+/g, '').toLowerCase();
                    container.innerHTML += `<div class='form-check'><input class='form-check-input' type='checkbox' value='${opt}' id='${id}' name='exerciseType'><label class='form-check-label' for='${id}'>${opt}</label></div>`;
                });
            } else if (value === 'measurement') {
                const options = ['Body Fat', 'Height', 'Weight'];
                options.forEach(opt => {
                    const id = 'measurement_' + opt.replace(/\s+/g, '').toLowerCase();
                    container.innerHTML += `<div class='form-check'><input class='form-check-input' type='checkbox' value='${opt}' id='${id}' name='measurementType'><label class='form-check-label' for='${id}'>${opt}</label></div>`;
                });
            } else if (value === 'achievement') {
                const options = ['Personal Best', 'Weekly Goal', 'Monthly Goal', 'Weight Loss Goal', 'Training Milestone'];
                options.forEach(opt => {
                    const id = 'achievement_' + opt.replace(/\s+/g, '').toLowerCase();
                    container.innerHTML += `<div class='form-check'><input class='form-check-input' type='checkbox' value='${opt}' id='${id}' name='achievementType'><label class='form-check-label' for='${id}'>${opt}</label></div>`;
                });
            }
            // Update scope immediately after checkboxes are rendered
            setTimeout(updateScopeHidden, 0);
        });

        document.getElementById('chartType').addEventListener('change', fetchAndPreviewShareData);
        document.getElementById('timeRange').addEventListener('change', fetchAndPreviewShareData);
        document.getElementById('subTypeCheckboxes').addEventListener('change', fetchAndPreviewShareData);
        
        // Initialize preview data on page load
        fetchAndPreviewShareData();
        
        // Initialize scope hidden field on page load
        updateScopeHidden();
    });

    // Function definitions outside of DOMContentLoaded event
    function deleteShareRecord(id) {
        fetch('/share/' + id, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                alert('Share record deleted successfully.');
                // Reload share records
                location.reload();
            });
    }

    // Expand all Sent Shares/Received Shares
    function renderSharesDetail(type, data) {
        let html = '';
        data.forEach(record => {
            html += `<div class="card mb-2"><div class="card-body">
                <h6 class="card-title">${type === 'sent' ? record.receiver_name : record.sender_name}</h6>
                <p class="card-text">${record.message}</p>
                <div class="text-muted small">${record.time || ''}</div>
            </div></div>`;
        });
        document.getElementById(type === 'sent' ? 'sentSharesDetail' : 'receivedSharesDetail').innerHTML = html;
    }

    // New: Dynamically render table headers and content
    function renderSharePreviewHeader(type) {
        const header = document.getElementById('sharePreviewHeader');
        let columns = ['Date'];
        if (type === 'exercise') {
            // Default display distance/duration, special handling for weightlifting and yoga
            const chartType = document.getElementById('chartType').value;
            const subTypes = Array.from(document.querySelectorAll('#subTypeCheckboxes input:checked')).map(i => i.value.toLowerCase());
            // If only one subtype is selected, render headers based on subtype, otherwise show all
            if (subTypes.length === 1) {
                if (['cycling', 'running', 'swimming'].includes(subTypes[0])) {
                    columns = ['Date', 'Type', 'Distance', 'Duration'];
                } else if (subTypes[0] === 'weight lifting') {
                    columns = ['Date', 'Type', 'Weight', 'Sets', 'Reps'];
                } else if (subTypes[0] === 'yoga') {
                    columns = ['Date', 'Type', 'Duration'];
                }
            } else {
                columns = ['Date', 'Type', 'Distance', 'Duration', 'Weight', 'Sets', 'Reps'];
            }
        } else if (type === 'measurement') {
            columns = ['Date', 'Type', 'Value'];
        } else if (type === 'calorie') {
            columns = ['Date', 'Calories'];
        }
        header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');
    }

    function renderSharePreviewTable(type, data) {
        const tbody = document.querySelector('#sharePreviewTable tbody');
        const empty = document.getElementById('sharePreviewEmpty');
        tbody.innerHTML = '';
        if (!data || data.length === 0) {
            empty.style.display = '';
            return;
        }
        empty.style.display = 'none';
        const subTypes = Array.from(document.querySelectorAll('#subTypeCheckboxes input:checked')).map(i => i.value.toLowerCase());
        data.forEach((item, idx) => {
            let row = '';
            if (type === 'exercise') {
                let t = (item.type || '').toLowerCase();
                if (['cycling', 'running', 'swimming'].includes(t)) {
                    row = `<td>${item.created_at ? (new Date(item.created_at)).toLocaleDateString() : '-'}</td>` +
                          `<td>${item.type || '-'}</td>` +
                          `<td>${item.metrics && item.metrics.distance !== undefined ? item.metrics.distance : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.duration !== undefined ? item.metrics.duration : '-'}</td>`;
                } else if (t === 'weight lifting') {
                    row = `<td>${item.created_at ? (new Date(item.created_at)).toLocaleDateString() : '-'}</td>` +
                          `<td>${item.type || '-'}</td>` +
                          `<td>${item.metrics && item.metrics.weight !== undefined ? item.metrics.weight : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.sets !== undefined ? item.metrics.sets : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.reps !== undefined ? item.metrics.reps : '-'}</td>`;
                } else if (t === 'yoga') {
                    row = `<td>${item.created_at ? (new Date(item.created_at)).toLocaleDateString() : '-'}</td>` +
                          `<td>${item.type || '-'}</td>` +
                          `<td>${item.metrics && item.metrics.duration !== undefined ? item.metrics.duration : '-'}</td>`;
                } else {
                    // Show all fields for mixed types
                    row = `<td>${item.created_at ? (new Date(item.created_at)).toLocaleDateString() : '-'}</td>` +
                          `<td>${item.type || '-'}</td>` +
                          `<td>${item.metrics && item.metrics.distance !== undefined ? item.metrics.distance : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.duration !== undefined ? item.metrics.duration : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.weight !== undefined ? item.metrics.weight : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.sets !== undefined ? item.metrics.sets : '-'}</td>` +
                          `<td>${item.metrics && item.metrics.reps !== undefined ? item.metrics.reps : '-'}</td>`;
                }
            } else if (type === 'measurement') {
                row = `<td>${item.created_at ? (new Date(item.created_at)).toLocaleDateString() : '-'}</td>` +
                      `<td>${item.type || '-'}</td>` +
                      `<td>${item.value !== undefined ? item.value : '-'}</td>`;
            } else if (type === 'calorie') {
                row = `<td>${item.created_at ? (new Date(item.created_at)).toLocaleDateString() : '-'}</td>` +
                      `<td>${item.calories !== undefined ? item.calories : '-'}</td>`;
            }
            tbody.innerHTML += `<tr>${row}</tr>`;
        });
    }

    // Listen for data type, time range and subtype changes to dynamically render preview
    function fetchAndPreviewShareData() {
        const type = document.getElementById('chartType').value;
        const days = document.getElementById('timeRange').value;
        renderSharePreviewHeader(type);
        if (!type || !days) {
            renderSharePreviewTable(type, []);
            return;
        }
        fetch(`/share/preview?type=${type}&days=${days}`)
            .then(res => res.json())
            .then(res => {
                if (res.code === 1 && Array.isArray(res.data)) {
                    renderSharePreviewTable(type, res.data);
                } else {
                    renderSharePreviewTable(type, []);
                }
            })
            .catch(() => renderSharePreviewTable(type, []));
    }
</script>
{% endblock %}