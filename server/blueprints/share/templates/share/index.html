{% extends "base.html" %}

{% block title %}
Share Data
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center align-items-start">
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                    <h4 class="mb-0">Share with Friends</h4>
                    <div class="text-muted small mt-1">Current User: {{ current_user.nickname }} ({{ current_user.username }})</div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="searchFriend" class="form-label">Search Friends</label>
                        <input type="text" id="searchFriend" class="form-control" placeholder="Search friends...">
                    </div>
                    <form id="friendShareForm" action="{{ url_for('share.create_share') }}" method="post" onsubmit="updateScopeHidden()">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            <label for="friendacSelect" class="form-label">Select Friend</label>
                            <select id="friendacSelect" class="form-select" name="receiver_id" size="5">
                                <!-- Dynamic friend options will be inserted here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" id="start_date" name="start_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" id="end_date" name="end_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="chartType" class="form-label">Data Type</label>
                            <select id="chartType" class="form-select" required>
                                <option value="" disabled selected>Please select a data type</option>
                                <option value="exercise">Exercise</option>
                                <option value="calorie">Calorie Intake</option>
                                <option value="measurement">Body Measurement</option>
                                <option value="achievement">Achievement</option>
                            </select>
                        </div>
                        <div id="subTypeCheckboxes" class="mb-3"></div>
                        <div id="chartPreview" class="my-3"></div>
                        <input type="hidden" id="scopeHidden" name="scope" value='{"exercise_types":[],"body_measurement_types":[],"achievements":[],"start_date":"","end_date":""}'>
                        <button type="submit" class="btn btn-primary">Share Data</button>
                    </form>
                    <div id="sendStatus" class="mt-3 text-success" style="display:none;">Data shared successfully with selected friends.</div>
                </div>
            </div>
        </div>
        <!-- Right Column: Share Records -->
        <div class="col-lg-7 mb-4 d-flex flex-column gap-4">
            <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                <div class="card-header bg-light d-flex justify-content-between align-items-center" style="border-radius: 1rem 1rem 0 0;">
                    <h4 class="mb-0">Share Records</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Sent Shares</h5>
                                <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#sentSharesModal">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                            </div>
                            <div id="shareSent"></div>
                            <div id="sentCountText" class="text-muted mt-2">You have shared 0 records.</div>
                        </div>
                        <hr class="my-2" style="border-top: 1px solid #e0e7ef; opacity: 1;">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Received Shares</h5>
                                <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#receivedSharesModal">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                            </div>
                            <div id="shareReceived"></div>
                            <div id="receivedCountText" class="text-muted mt-2">You have received 0 records.</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- New: Data Sharing Preview Card -->
            <div class="col-lg-12 mb-4">
                <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                    <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                        <h4 class="mb-0">Preview Data to Share</h4>
                    </div>
                    <div class="card-body p-3">
                        <table class="table table-striped" id="sharePreviewTable">
                            <thead>
                            <tr id="sharePreviewHeader">
                                <!-- Dynamically insert headers -->
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Dynamically insert preview data -->
                            </tbody>
                        </table>
                        <div id="sharePreviewEmpty" class="text-muted text-center" style="display:none;">No data to preview. Please select data type.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sent Shares Modal -->
<div class="modal fade" id="sentSharesModal" tabindex="-1" aria-labelledby="sentSharesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sentSharesModalLabel">All Sent Shares</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="sentSharesDetail"></div>
            </div>
        </div>
    </div>
</div>
<!-- Received Shares Modal -->
<div class="modal fade" id="receivedSharesModal" tabindex="-1" aria-labelledby="receivedSharesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receivedSharesModalLabel">All Received Shares</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="receivedSharesDetail"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<style>
    body {
        background: #292a2c51 !important;
    }
    .card {
        border-radius: 1rem !important;
        margin-bottom: 1rem;
    }
    .card-header.bg-light {
        background: #f8fafc !important;
        font-size: 1.15rem;
        font-weight: 600;
        border-bottom: 1px solid #e0e7ef;
        letter-spacing: 0.01em;
    }
    .btn-circle {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff86a;
        color: #222;
        border: none;
        font-size: 1.3rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        transition: background 0.2s;
    }
    .btn-circle:hover {
        background: #ffe066;
    }
    .btn-add {
        background: #fff86a;
        color: #222;
    }
    .btn-copy {
        font-size: 1rem;
        margin-left: 1rem;
    }
    .card h4, .card h5 {
        font-size: 1.15rem;
        font-weight: 600;
    }
    .form-control, .form-select {
        border-radius: 0.7rem;
    }
    .form-text {
        color: #888;
    }
    .input-group .form-control {
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block js %}
{{ super() }}
<script>
const rawData = {
  exercise: {{ current_user.exercises | tojson }},
  measurement: {{ current_user.body_measurements | tojson }},
  calorie_intake: {{ current_user.calorie_intakes | tojson }},
  achievement: {{ current_user.achievements | tojson }}
};

// Function definitions in global scope
function deleteShareRecord(id) {
    fetch('/share/' + id, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            alert('Share record deleted successfully.');
            // Reload share records
            location.reload();
        });
}

// Add timezone conversion function, consistent with browse page
function convertTimezone(data, key = "created_at") {
    if (!Array.isArray(data)) return data;
    
    const result = JSON.parse(JSON.stringify(data)); // Deep copy of the array
    for (let i = 0; i < result.length; i++) {
        if (result[i][key]) {
            const date = new Date(result[i][key]);
            result[i][key] = date.toLocaleString();
        }
    }
    return result;
}

// Save filter conditions to sessionStorage
function saveFilterState() {
    const state = {
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        chartType: document.getElementById('chartType').value,
        exerciseTypes: Array.from(document.querySelectorAll('input[name="exerciseType"]:checked')).map(i => i.value),
        measurementTypes: Array.from(document.querySelectorAll('input[name="measurementType"]:checked')).map(i => i.value),
        achievementTypes: Array.from(document.querySelectorAll('input[name="achievementType"]:checked')).map(i => i.value)
    };
    sessionStorage.setItem('shareFilterState', JSON.stringify(state));
    console.log('Filter state saved (valid for current session):', state);
}

// Restore filter conditions from sessionStorage
function restoreFilterState() {
    const stateStr = sessionStorage.getItem('shareFilterState');
    if (!stateStr) return;
    
    try {
        const state = JSON.parse(stateStr);
        console.log('Restoring filter state:', state);
        
        // Restore dates
        if (state.start_date) document.getElementById('start_date').value = state.start_date;
        if (state.end_date) document.getElementById('end_date').value = state.end_date;
        
        // Restore data type selection
        if (state.chartType) {
            const chartTypeSelect = document.getElementById('chartType');
            chartTypeSelect.value = state.chartType;
            
            // Trigger change event to generate appropriate sub-type checkboxes
            const event = new Event('change');
            chartTypeSelect.dispatchEvent(event);
            
            // Wait for sub-type checkboxes to be generated before restoring selection states
            setTimeout(() => {
                // Restore exercise type selection
                if (state.exerciseTypes && state.chartType === 'exercise') {
                    state.exerciseTypes.forEach(type => {
                        const checkbox = document.querySelector(`input[name="exerciseType"][value="${type}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Restore body measurement type selection
                if (state.measurementTypes && state.chartType === 'measurement') {
                    state.measurementTypes.forEach(type => {
                        const checkbox = document.querySelector(`input[name="measurementType"][value="${type}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Restore achievement type selection
                if (state.achievementTypes && state.chartType === 'achievement') {
                    state.achievementTypes.forEach(type => {
                        const checkbox = document.querySelector(`input[name="achievementType"][value="${type}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Trigger data preview update
                fetchAndPreviewShareData();
            }, 100);
        }
    } catch (e) {
        console.error('Failed to restore filter state:', e);
    }
}

// Expand all Sent Shares/Received Shares
function renderSharesDetail(type, data) {
    let html = '';
    data.forEach(record => {
        html += `<div class="card mb-2"><div class="card-body">
            <h6 class="card-title">${type === 'sent' ? record.receiver_name : record.sender_name}</h6>
            <p class="card-text">${record.message}</p>
            <div class="text-muted small">${record.time || ''}</div>
        </div></div>`;
    });
    document.getElementById(type === 'sent' ? 'sentSharesDetail' : 'receivedSharesDetail').innerHTML = html;
}

// Dynamic render table headers based on data type
function renderSharePreviewHeader(type) {
    const header = document.getElementById('sharePreviewHeader');
    let columns = ['Date'];
    if (type === 'exercise') {
        // Get selected subtypes for specific header rendering
        const subTypes = Array.from(document.querySelectorAll('#subTypeCheckboxes input:checked')).map(i => i.value.toLowerCase());
        
        // If only one subtype is selected, render headers based on subtype
        if (subTypes.length === 1) {
            if (['cycling', 'running', 'swimming'].includes(subTypes[0])) {
                columns = ['Date', 'Type', 'Distance', 'Duration'];
            } else if (subTypes[0] === 'weight lifting') {
                columns = ['Date', 'Type', 'Weight', 'Sets', 'Reps'];
            } else if (subTypes[0] === 'yoga') {
                columns = ['Date', 'Type', 'Duration'];
            }
        } else {
            // Show all possible fields if multiple types selected
            columns = ['Date', 'Type', 'Distance', 'Duration', 'Weight', 'Sets', 'Reps'];
        }
    } else if (type === 'measurement') {
        columns = ['Date', 'Type', 'Value'];
    } else if (type === 'calorie') {
        columns = ['Date', 'Calories'];
    } else if (type === 'achievement') {
        columns = ['Date', 'Type', 'Milestone'];
    }
    header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');
}

// Render preview table with filtered data
function renderSharePreviewTable(type, data) {
    const tbody = document.querySelector('#sharePreviewTable tbody');
    const empty = document.getElementById('sharePreviewEmpty');
    tbody.innerHTML = '';
    
    // Debug: Print final processed data
    console.log('Rendering preview table with data type:', type);
    console.log('Data to render:', data);
    
    // Handle empty data case
    if (!data || data.length === 0) {
        empty.style.display = '';
        return;
    }
    empty.style.display = 'none';
    
    const subTypes = Array.from(document.querySelectorAll('#subTypeCheckboxes input:checked')).map(i => i.value.toLowerCase());
    
    data.forEach((item) => {
        let row = '';
        if (type === 'exercise') {
            let t = (item.type || '').toLowerCase();
            if (['cycling', 'running', 'swimming'].includes(t)) {
                // Get distance and duration, prioritize metrics object but also check root properties
                const distance = 
                    (item.metrics && item.metrics.distance !== undefined) ? item.metrics.distance :
                    item.distance !== undefined ? item.distance : '-';
                
                const duration = 
                    (item.metrics && item.metrics.duration !== undefined) ? item.metrics.duration :
                    item.duration !== undefined ? item.duration : '-';
                
                row = `<td>${item.created_at || '-'}</td>` +
                      `<td>${item.type || '-'}</td>` +
                      `<td>${distance}</td>` +
                      `<td>${duration}</td>`;
            } else if (t === 'weight lifting') {
                row = `<td>${item.created_at || '-'}</td>` +
                      `<td>${item.type || '-'}</td>` +
                      `<td>${item.metrics && item.metrics.weight !== undefined ? item.metrics.weight : '-'}</td>` +
                      `<td>${item.metrics && item.metrics.sets !== undefined ? item.metrics.sets : '-'}</td>` +
                      `<td>${item.metrics && item.metrics.reps !== undefined ? item.metrics.reps : '-'}</td>`;
            } else if (t === 'yoga') {
                row = `<td>${item.created_at || '-'}</td>` +
                      `<td>${item.type || '-'}</td>` +
                      `<td>${item.metrics && item.metrics.duration !== undefined ? item.metrics.duration : '-'}</td>`;
            } else {
                // Directly get distance and duration, prioritize metrics object but also check root properties
                const distance = 
                    (item.metrics && item.metrics.distance !== undefined) ? item.metrics.distance :
                    item.distance !== undefined ? item.distance : '-';
                
                const duration = 
                    (item.metrics && item.metrics.duration !== undefined) ? item.metrics.duration :
                    item.duration !== undefined ? item.duration : '-';
                
                const weight = (item.metrics && item.metrics.weight !== undefined) ? item.metrics.weight : 
                              (item.weight !== undefined ? item.weight : '-');
                
                const sets = (item.metrics && item.metrics.sets !== undefined) ? item.metrics.sets : 
                            (item.sets !== undefined ? item.sets : '-');
                
                const reps = (item.metrics && item.metrics.reps !== undefined) ? item.metrics.reps : 
                            (item.reps !== undefined ? item.reps : '-');
                
                row = `<td>${item.created_at || '-'}</td>` +
                      `<td>${item.type || '-'}</td>` +
                      `<td>${distance}</td>` +
                      `<td>${duration}</td>` +
                      `<td>${weight}</td>` +
                      `<td>${sets}</td>` +
                      `<td>${reps}</td>`;
            }
        } else if (type === 'measurement') {
            row = `<td>${item.created_at || '-'}</td>` +
                  `<td>${item.type || '-'}</td>` +
                  `<td>${item.value !== undefined ? item.value : '-'}</td>`;
        } else if (type === 'calorie') {
            row = `<td>${item.created_at || '-'}</td>` +
                  `<td>${item.calories !== undefined ? item.calories : '-'}</td>`;
        } else if (type === 'achievement') {
            row = `<td>${item.created_at || '-'}</td>` +
                  `<td>${item.type || '-'}</td>` +
                  `<td>${item.milestone !== undefined ? item.milestone : '-'}</td>`;
        }
        tbody.innerHTML += `<tr>${row}</tr>`;
    });
}

// Collect and update filter scope values
function updateScopeHidden() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const exerciseTypes = Array.from(document.querySelectorAll('input[name="exerciseType"]:checked')).map(i => i.value);
    const bodyMeasurementTypes = Array.from(document.querySelectorAll('input[name="measurementType"]:checked')).map(i => i.value);
    const achievements = Array.from(document.querySelectorAll('input[name="achievementType"]:checked')).map(i => i.value);

    const scope = {
        exercise_types: exerciseTypes,
        body_measurement_types: bodyMeasurementTypes,
        achievements: achievements,
        start_date: startDate,
        end_date: endDate
    };
    document.getElementById('scopeHidden').value = JSON.stringify(scope);
    
    // Save current filter conditions to sessionStorage
    saveFilterState();
}

// Fetch data locally and apply filters
function fetchAndPreviewShareData() {
    updateScopeHidden();
    const scope = JSON.parse(document.getElementById('scopeHidden').value);
    const type = document.getElementById('chartType').value;
    
    // Render appropriate headers based on data type
    renderSharePreviewHeader(type);
    
    // Handle empty type selection
    if (!type) {
        renderSharePreviewTable(type, []);
        return;
    }

    // Get raw data from the globally defined rawData
    let list = [];
    
    // Map the UI type to the rawData key
    const dataTypeMap = {
        'exercise': 'exercise',
        'measurement': 'measurement',
        'calorie': 'calorie_intake',  // Fix mapping
        'achievement': 'achievement'
    };
    
    // Get the correct data key
    const dataKey = dataTypeMap[type] || type.toLowerCase().replace(' ', '_');
    console.log('Data key for type:', type, 'is', dataKey);
    
    if (rawData && rawData[dataKey]) {
        list = [...rawData[dataKey]];
        console.log(`Found ${list.length} records for ${dataKey}`);
    } else {
        console.log(`No data found for key ${dataKey} in rawData:`, Object.keys(rawData));
    }

    // Process exercise metrics - ensure they're objects not strings
    if (type === 'exercise') {
        list = list.map(item => {
            const newItem = {...item};
            
            // Initialize metrics object (if it doesn't exist or is undefined)
            if (!newItem.metrics || typeof newItem.metrics === 'undefined') {
                newItem.metrics = {};
                
                // If distance and duration exist as independent properties in the item rather than in metrics subobject
                if (newItem.distance !== undefined) {
                    newItem.metrics.distance = newItem.distance;
                }
                
                if (newItem.duration !== undefined) {
                    newItem.metrics.duration = newItem.duration;
                }
            } else if (typeof newItem.metrics === 'string') {
                try {
                    // Try to parse single-quote JSON
                    newItem.metrics = JSON.parse(newItem.metrics.replace(/'/g,'"'));
                } catch (e) {
                    // Try more aggressive cleaning method
                    try {
                        const cleanString = newItem.metrics
                            .replace(/'/g, '"')
                            .replace(/([{,]\s*)(\w+)(\s*:)/g, '$1"$2"$3'); // Ensure key names have quotes
                        newItem.metrics = JSON.parse(cleanString);
                    } catch (e2) {
                        newItem.metrics = {};
                        
                        // If metrics parsing fails, try to get from item root properties
                        if (newItem.distance !== undefined) {
                            newItem.metrics.distance = newItem.distance;
                        }
                        if (newItem.duration !== undefined) {
                            newItem.metrics.duration = newItem.duration;
                        }
                    }
                }
            }
            
            // Additional check at this stage
            // If metrics is still empty but distance and duration data exist on item root properties
            if (Object.keys(newItem.metrics).length === 0) {
                if (newItem.distance !== undefined) {
                    newItem.metrics.distance = newItem.distance;
                }
                if (newItem.duration !== undefined) {
                    newItem.metrics.duration = newItem.duration;
                }
            }
            
            return newItem;
        });
    }

    // Apply date filter if dates are specified
    if (scope.start_date || scope.end_date) {
        // Convert local date to UTC time, considering timezone differences
        const sd = scope.start_date ? new Date(scope.start_date + 'T00:00:00') : new Date(0);
        
        // Set end date to end of day to include the entire day
        const ed = scope.end_date ? new Date(scope.end_date + 'T23:59:59') : new Date(8640000000000000);
        
        list = list.filter(item => {
            if (!item.created_at) return false;
            const d = new Date(item.created_at);
            return d >= sd && d <= ed;
        });
    }

    // Apply type filters
    if (type === 'exercise' && scope.exercise_types && scope.exercise_types.length) {
        const exTypes = scope.exercise_types.map(v => v.toLowerCase());
        list = list.filter(item => item.type && exTypes.includes(item.type.toLowerCase()));
    }
    
    if (type === 'measurement' && scope.body_measurement_types && scope.body_measurement_types.length) {
        const measurementTypes = scope.body_measurement_types.map(v => v.toLowerCase());
        list = list.filter(item => item.type && measurementTypes.includes(item.type.toLowerCase()));
    }
    
    if (type === 'achievement' && scope.achievements && scope.achievements.length) {
        const achievementTypes = scope.achievements.map(v => v.toLowerCase());
        list = list.filter(item => item.type && achievementTypes.includes(item.type.toLowerCase()));
    }

    // Apply timezone conversion - filter first then convert timezone
    list = convertTimezone(list);

    // Render the filtered data
    renderSharePreviewTable(type, list);
}

// Function to set default dates to today
function setDefaultDates() {
    const today = new Date();
    const year = today.getFullYear();
    // Month is 0-indexed in JS, so add 1, and ensure two digits
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    
    const todayFormatted = `${year}-${month}-${day}`;
    
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Set default values if not already set
    if (!startDateInput.value) {
        startDateInput.value = todayFormatted;
    }
    
    if (!endDateInput.value) {
        endDateInput.value = todayFormatted;
    }
    
    // Set max attribute to limit dates to today
    startDateInput.max = todayFormatted;
    endDateInput.max = todayFormatted;
    
    // Add event listeners for date validation
    startDateInput.addEventListener('change', function() {
        // End date cannot be earlier than start date
        endDateInput.min = this.value;
        
        // If end date is now invalid (earlier than start), update it
        if (endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
        
        fetchAndPreviewShareData();
        saveFilterState();
    });
    
    endDateInput.addEventListener('change', function() {
        // Start date cannot be later than end date
        startDateInput.max = this.value;
        
        // If start date is now invalid (later than end), update it
        if (startDateInput.value > this.value) {
            startDateInput.value = this.value;
        }
        
        fetchAndPreviewShareData();
        saveFilterState();
    });
}

// Wait for DOM content to load before attaching event listeners
window.addEventListener('DOMContentLoaded', () => {
    // Set default dates to today
    setDefaultDates();
    
    // Try to restore previously saved filter state
    restoreFilterState();

    // Search friends functionality
    document.getElementById('searchFriend').addEventListener('input', function() {
        const username = this.value.trim();
        const friendSelect = document.getElementById('friendacSelect');
        friendSelect.innerHTML = '';
        if (!username) return;
        fetch(`/user/${encodeURIComponent(username)}`)
            .then(res => res.json())
            .then(res => {
                if (res.code === 1 && Array.isArray(res.data)) {
                    res.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.text = user.nickname ? `${user.nickname}（${user.username}）` : user.username;
                        friendSelect.appendChild(option);
                    });
                }
            });
    });

    // Initialize share record displays
    const shareSent = document.getElementById('shareSent');
    const shareReceived = document.getElementById('shareReceived');
    shareSent.innerHTML = '';
    shareReceived.innerHTML = '';
    
    // Initialize counter displays
    const sentCountText = document.getElementById('sentCountText');
    if (sentCountText) {
        sentCountText.textContent = 'You have successfully shared 0 records.';
    }
    const receivedCountText = document.getElementById('receivedCountText');
    if (receivedCountText) {
        receivedCountText.textContent = 'You have received 0 records.';
    }

    // Modal event handlers
    const sentModal = document.getElementById('sentSharesModal');
    sentModal && sentModal.addEventListener('show.bs.modal', function () {
        renderSharesDetail('sent', []);
    });
    const receivedModal = document.getElementById('receivedSharesModal');
    receivedModal && receivedModal.addEventListener('show.bs.modal', function () {
        renderSharesDetail('received', []);
    });

    // Date range filter event handlers
    document.getElementById('start_date').addEventListener('change', function() {
        fetchAndPreviewShareData();
        saveFilterState();
    });
    document.getElementById('end_date').addEventListener('change', function() {
        fetchAndPreviewShareData();
        saveFilterState();
    });
    
    // Sub-type filter event delegation
    document.getElementById('subTypeCheckboxes').addEventListener('change', function() {
        fetchAndPreviewShareData();
        saveFilterState();
    });

    // Data type selection handler - generates appropriate sub-type filters
    document.getElementById('chartType').addEventListener('change', function() {
        var value = this.value;
        var container = document.getElementById('subTypeCheckboxes');
        container.innerHTML = '';
        
        if (value === 'exercise') {
            const options = ['Cycling', 'Running', 'Swimming', 'Weight Lifting', 'Yoga'];
            options.forEach(opt => {
                const id = 'exercise_' + opt.replace(/\s+/g, '').toLowerCase();
                container.innerHTML += `<div class='form-check'><input class='form-check-input' type='checkbox' value='${opt}' id='${id}' name='exerciseType'><label class='form-check-label' for='${id}'>${opt}</label></div>`;
            });
        } else if (value === 'measurement') {
            const options = ['Body Fat', 'Height', 'Weight'];
            options.forEach(opt => {
                const id = 'measurement_' + opt.replace(/\s+/g, '').toLowerCase();
                container.innerHTML += `<div class='form-check'><input class='form-check-input' type='checkbox' value='${opt}' id='${id}' name='measurementType'><label class='form-check-label' for='${id}'>${opt}</label></div>`;
            });
        } else if (value === 'achievement') {
            const options = ['Personal Best', 'Weekly Goal', 'Monthly Goal', 'Weight Loss Goal', 'Training Milestone'];
            options.forEach(opt => {
                const id = 'achievement_' + opt.replace(/\s+/g, '').toLowerCase();
                container.innerHTML += `<div class='form-check'><input class='form-check-input' type='checkbox' value='${opt}' id='${id}' name='achievementType'><label class='form-check-label' for='${id}'>${opt}</label></div>`;
            });
        }
        
        // Save data type selection
        saveFilterState();
        
        // Update preview immediately after changing data type
        setTimeout(fetchAndPreviewShareData, 0);
    });
    
    // Initialize preview data on page load
    updateScopeHidden();
    fetchAndPreviewShareData();
});
</script>
{% endblock %}