{% extends "base.html" %}

{% block title %}
Share Data
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row">
                <!-- Left Column: Share with Friends -->
                <div class="col-lg-5 mb-4">
                    <div class="card shadow-sm border-0 h-100" style="border-radius: 1rem;">
                        <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                            <h4 class="mb-0">Share with Friends</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <input type="text" id="searchFriend" class="form-control" placeholder="Search friends...">
                            </div>
                            <form id="friendShareForm">
                                <div class="mb-3">
                                    <label for="friendSelect" class="form-label">Select Friends</label>
                                    <select id="friendSelect" class="form-select" multiple required></select>
                                    <div class="form-text">Hold Ctrl (Windows) or Command (Mac) to select multiple friends.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="chartType" class="form-label">Chart to Share</label>
                                    <select id="chartType" class="form-select" required>
                                        <option value="" disabled selected>Please select a chart</option>
                                        <option value="calories_burned">Calories Burned</option>
                                        <option value="weight_trend">Weight Trend</option>
                                        <option value="calorie_intake">Calorie Intake</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Time Range</label>
                                    <div>
                                        <input type="radio" id="days7" name="shareDays" value="7" checked>
                                        <label for="days7">Last 7 days</label>
                                        <input type="radio" id="days14" name="shareDays" value="14">
                                        <label for="days14">Last 14 days</label>
                                    </div>
                                </div>
                                <div id="chartPreview" class="my-3"></div>
                                <div class="mb-3">
                                    <label for="note" class="form-label">Optional Message</label>
                                    <textarea class="form-control" id="note" rows="2" placeholder="Write a short message..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Share Data</button>
                            </form>
                            <div id="sendStatus" class="mt-3 text-success" style="display:none;">Data shared successfully with selected friends.</div>
                        </div>
                    </div>
                </div>
                <!-- Right Column: Generate Link + Share Records -->
                <div class="col-lg-7 mb-4 d-flex flex-column gap-4">
                    <div class="card shadow-sm border-0" style="border-radius: 1rem;">
                        <div class="card-header bg-light" style="border-radius: 1rem 1rem 0 0;">
                            <h4 class="mb-0">Generate Shareable Link</h4>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" class="form-control" id="shareLink" value="https://yourdomain.com/share/ABC123" readonly>
                                <button class="btn btn-outline-secondary btn-copy" onclick="copyLink()">Copy</button>
                            </div>
                            <div class="text-muted mt-2">This link grants access to your analysis summary.</div>
                        </div>
                    </div>
                    <div class="card shadow-sm border-0 flex-fill" style="border-radius: 1rem;">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center" style="border-radius: 1rem 1rem 0 0;">
                            <h4 class="mb-0">Share Records</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 mb-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Sent Shares</h5>
                                        <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#sentSharesModal">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <div id="shareSent"></div>
                                    <div id="sentCountText" class="text-muted mt-2">You have shared 0 records.</div>
                                </div>
                                <hr class="my-2" style="border-top: 1px solid #e0e7ef; opacity: 1;">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Received Shares</h5>
                                        <button class="btn btn-circle btn-add" data-bs-toggle="modal" data-bs-target="#receivedSharesModal">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <div id="shareReceived"></div>
                                    <div id="receivedCountText" class="text-muted mt-2">You have received 0 records.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sent Shares Modal -->
<div class="modal fade" id="sentSharesModal" tabindex="-1" aria-labelledby="sentSharesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sentSharesModalLabel">All Sent Shares</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="sentSharesDetail"></div>
            </div>
        </div>
    </div>
</div>
<!-- Received Shares Modal -->
<div class="modal fade" id="receivedSharesModal" tabindex="-1" aria-labelledby="receivedSharesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receivedSharesModalLabel">All Received Shares</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="receivedSharesDetail"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<style>
    body {
        background: #292a2c51 !important;
        font-size: 1.05rem;
        font-family: 'Segoe UI', 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
    }
    .card {
        border-radius: 1rem !important;
    }
    .card-header.bg-light {
        background: #f8fafc !important;
        font-size: 1.15rem;
        font-weight: 600;
        border-bottom: 1px solid #e0e7ef;
        letter-spacing: 0.01em;
    }
    .btn-circle {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff86a;
        color: #222;
        border: none;
        font-size: 1.3rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        transition: background 0.2s;
    }
    .btn-circle:hover {
        background: #ffe066;
    }
    .btn-add {
        background: #fff86a;
        color: #222;
    }
    .btn-copy {
        font-size: 1rem;
        margin-left: 1rem;
    }
    .card h4, .card h5 {
        font-size: 1.15rem;
        font-weight: 600;
    }
    .form-control, .form-select {
        border-radius: 0.7rem;
    }
    .form-text {
        color: #888;
    }
    .input-group .form-control {
        font-size: 1rem;
    }
    .card {
        margin-bottom: 1rem;
    }
    .mb-3 {
        margin-bottom: 1.2rem !important;
    }
    .mt-3 {
        margin-top: 1.2rem !important;
    }
    .gap-4 > * + * {
        margin-top: 1.5rem !important;
    }
</style>
{% endblock %}

{% block js %}
{{ super() }}
<script>
    document.getElementById('friendShareForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const selectedFriends = Array.from(document.getElementById('friendSelect').selectedOptions).map(opt => opt.value);
        const chartType = document.getElementById('chartType').value;
        const shareDays = document.querySelector('input[name="shareDays"]:checked').value;
        const note = document.getElementById('note').value;
        if (selectedFriends.length > 0 && chartType && shareDays) {
            // You can submit these data to backend here
            console.log({
                selectedFriends,
                chartType,
                shareDays,
                note
            });
            document.getElementById('sendStatus').style.display = "block";
        } else {
            alert("Please select friends, chart and time range!");
        }
    });

    function copyLink() {
        const copyText = document.getElementById("shareLink");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand("copy");
        alert("Link copied to clipboard.");
    }

    // Add search functionality for friends
    document.getElementById('searchFriend').addEventListener('input', function() {
        const username = this.value.trim();
        const friendSelect = document.getElementById('friendSelect');
        // 清空下拉框
        friendSelect.innerHTML = '';
        if (!username) return;
        fetch(`/user/${encodeURIComponent(username)}`)
            .then(res => res.json())
            .then(res => {
                if (res.code === 1 && Array.isArray(res.data)) {
                    res.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.text = user.nickname ? `${user.nickname}（${user.username}）` : user.username;
                        friendSelect.appendChild(option);
                    });
                }
            });
    });

    // Fetch and render share records from backend
    fetch('/api/share-records')
        .then(response => response.json())
        .then(data => {
            const shareSent = document.getElementById('shareSent');
            const shareReceived = document.getElementById('shareReceived');
            shareSent.innerHTML = '';
            shareReceived.innerHTML = '';
            data.share_sent.forEach(record => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${record.receiver_name}</h5>
                        <p class="card-text">${record.message}</p>
                        <button class="btn btn-danger" onclick="deleteShareRecord(${record.id})">Delete</button>
                    </div>
                `;
                shareSent.appendChild(card);
            });
            data.share_received.forEach(record => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${record.sender_name}</h5>
                        <p class="card-text">${record.message}</p>
                    </div>
                `;
                shareReceived.appendChild(card);
            });
            // 动态更新分享数量文本
            const sentCountText = document.getElementById('sentCountText');
            if (sentCountText) {
                sentCountText.textContent = `You have successfully shared ${data.share_sent.length} records.`;
            }
            const receivedCountText = document.getElementById('receivedCountText');
            if (receivedCountText) {
                receivedCountText.textContent = `You have received ${data.share_received.length} records.`;
            }
        });

    function deleteShareRecord(id) {
        fetch(`/api/share-records/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                alert('Share record deleted successfully.');
                // 重新加载分享记录
                location.reload();
            });
    }

    // 展开全部Sent Shares/Received Shares
    function renderSharesDetail(type, data) {
        let html = '';
        data.forEach(record => {
            html += `<div class="card mb-2"><div class="card-body">
                <h6 class="card-title">${type === 'sent' ? record.receiver_name : record.sender_name}</h6>
                <p class="card-text">${record.message}</p>
                <div class="text-muted small">${record.time || ''}</div>
            </div></div>`;
        });
        document.getElementById(type === 'sent' ? 'sentSharesDetail' : 'receivedSharesDetail').innerHTML = html;
    }

    // 监听modal弹窗显示，动态加载数据
    const sentModal = document.getElementById('sentSharesModal');
    sentModal && sentModal.addEventListener('show.bs.modal', function () {
        fetch('/api/share-records')
            .then(response => response.json())
            .then(data => renderSharesDetail('sent', data.share_sent));
    });
    const receivedModal = document.getElementById('receivedSharesModal');
    receivedModal && receivedModal.addEventListener('show.bs.modal', function () {
        fetch('/api/share-records')
            .then(response => response.json())
            .then(data => renderSharesDetail('received', data.share_received));
    });
</script>
{% endblock %}